<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>lectures/lecture3/Program.hs</title>
</head>
<body>
<pre><font color=Blue>-- | Using the 'Program' monad</font>
<u><font color="#804000">module</font></u> <font color=Green>Program</font>
  <font color="#808080">(</font> <u><font color="#804000">module</font></u> <font color=Green>ProgramImpl</font>
  <font color="#808080">,</font> putS<font color="#808080">,</font> putSLn<font color="#808080">,</font> getLn
  <font color="#808080">,</font> runPut<font color="#808080">,</font> run_<font color="#808080">,</font> runIO<font color="#808080">,</font> runIONonBlocking
  <font color="#808080">)</font>
  <u><font color="#804000">where</font></u>

<u><font color="#804000">import</font></u> <font color=Green>System</font><font color="#800080">.</font><font color=Green>IO</font>
<u><font color="#804000">import</font></u> <font color=Green>Program</font><font color="#800080">.</font><font color=Green>Deep2</font> <u><font color="#804000">as</font></u> <font color=Green>ProgramImpl</font>
<font color=Blue>-- import Program.Shallow as ProgramImpl</font>

<font color=Blue>-- | Print a string.</font>
putS <font color="#808080">::</font> <font color=Green>String</font> <font color="#808080">-&gt;</font> <font color=Green>Program</font> <font color=Green>()</font>
putS <font color="#808080">=</font> mapM_ putC

<font color=Blue>-- | Print a string and add a new line to the end.</font>
putSLn <font color="#808080">::</font> <font color=Green>String</font> <font color="#808080">-&gt;</font> <font color=Green>Program</font> <font color=Green>()</font>
putSLn s <font color="#808080">=</font> putS <font color="#808080">(</font>s <font color="#800080">++</font> <font color=Magenta>"\n"</font><font color="#808080">)</font>

<font color=Blue>-- | Read a line from the input.</font>
getLn <font color="#808080">::</font> <font color=Green>Program</font> <font color=Green>String</font>
getLn <font color="#808080">=</font> <u><font color="#804000">do</font></u>
  mc <font color="#808080">&lt;-</font> getC
  <u><font color="#804000">case</font></u> mc <u><font color="#804000">of</font></u>
    <font color=Green>Nothing</font>   <font color="#808080">-&gt;</font> return <font color=Magenta>""</font>
    <font color=Green>Just</font> <font color=Magenta>'\n'</font> <font color="#808080">-&gt;</font> return <font color=Magenta>""</font>
    <font color=Green>Just</font> c    <font color="#808080">-&gt;</font> <u><font color="#804000">do</font></u>
      s <font color="#808080">&lt;-</font> getLn
      return <font color="#800080">$</font> c <b><font color="#800080">:</font></b> s

<font color=Blue>-- | Run function which throws away the remaining inputs.</font>
run_ <font color="#808080">::</font> <font color=Green>Program</font> a <font color="#808080">-&gt;</font> <font color=Green>Input</font> <font color="#808080">-&gt;</font> <font color="#808080">(</font>a<font color="#808080">,</font> <font color=Green>Output</font><font color="#808080">)</font>
run_ p i <font color="#808080">=</font> <u><font color="#804000">case</font></u> run p i <u><font color="#804000">of</font></u>
  <font color="#808080">(</font>x<font color="#808080">,</font> <u><font color="#804000">_</font></u><font color="#808080">,</font> o<font color="#808080">)</font> <font color="#808080">-&gt;</font> <font color="#808080">(</font>x<font color="#808080">,</font> o<font color="#808080">)</font>

<font color=Blue>-- | Run a program p with input i as an IO computation writing to</font>
<font color=Blue>--   stdout.</font>
runPut <font color="#808080">::</font> <font color=Green>Program</font> b <font color="#808080">-&gt;</font> <font color=Green>Input</font> <font color="#808080">-&gt;</font> <font color=Green>IO</font> b
runPut p i <font color="#808080">=</font> <u><font color="#804000">do</font></u> 
  <u><font color="#804000">let</font></u> <font color="#808080">(</font>x<font color="#808080">,</font> o<font color="#808080">)</font> <font color="#808080">=</font> run_ p i
  putStr o
  return x

<font color=Blue>-- | Run a program as an IO computation reading from stdin and</font>
<font color=Blue>--   writing to stdout.</font>
runIO <font color="#808080">::</font> <font color=Green>Program</font> a <font color="#808080">-&gt;</font> <font color=Green>IO</font> a
runIO p <font color="#808080">=</font> getContents <font color="#800080">&gt;&gt;=</font> runPut p

<font color=Blue>-- | Run a program on whatever is available on stdin at the moment.</font>
<font color=Blue>--   Useful for writing event driven programs where you don't want</font>
<font color=Blue>--   to block the program waiting for the user to press a key.</font>
runIONonBlocking <font color="#808080">::</font> <font color=Green>Program</font> a <font color="#808080">-&gt;</font> <font color=Green>IO</font> a
runIONonBlocking p <font color="#808080">=</font> getString <font color="#800080">&gt;&gt;=</font> runPut p
  <u><font color="#804000">where</font></u>
    <font color=Blue>-- Read as much from stdin as possible without blocking.</font>
    getString <font color="#808080">=</font> whileM <font color="#808080">(</font>hReady stdin<font color="#808080">)</font> getChar

<font color=Blue>-- | I wonder why this one isn't in the libraries...</font>
whileM <font color="#808080">::</font> <font color=Green>Monad</font> m <font color="#808080">=&gt;</font> m <font color=Green>Bool</font> <font color="#808080">-&gt;</font> m a <font color="#808080">-&gt;</font> m <font color="#808080">[</font>a<font color="#808080">]</font>
whileM cond body <font color="#808080">=</font> <u><font color="#804000">do</font></u>
  ok <font color="#808080">&lt;-</font> cond
  <u><font color="#804000">if</font></u> ok <u><font color="#804000">then</font></u> <u><font color="#804000">do</font></u>
      x <font color="#808080">&lt;-</font> body
      xs <font color="#808080">&lt;-</font> whileM cond body
      return <font color="#808080">(</font>x <b><font color="#800080">:</font></b> xs<font color="#808080">)</font>
    <u><font color="#804000">else</font></u>
      return <font color=Green>[]</font>

</pre>
</body>
</html>