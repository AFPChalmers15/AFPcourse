<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>lectures/lecture3/Program/Deep1.hs</title>
</head>
<body>
<pre><font color=Blue>{-# LANGUAGE GADTs #-}</font>
<font color=Blue>{-|
  A simple embedded language for input/output. Deep embedding.
-}</font>
<u><font color="#804000">module</font></u> <font color=Green>Program</font><font color="#800080">.</font><font color=Green>Deep1</font> <u><font color="#804000">where</font></u>

<u><font color="#804000">type</font></u> <font color=Green>Input</font>   <font color="#808080">=</font>  <font color=Green>String</font>
<u><font color="#804000">type</font></u> <font color=Green>Output</font>  <font color="#808080">=</font>  <font color=Green>String</font>

<u><font color="#804000">data</font></u> <font color=Green>Program</font> a <u><font color="#804000">where</font></u>
  <font color=Green>Put</font>    <font color="#808080">::</font> <font color=Green>Char</font> <font color="#808080">-&gt;</font> <font color=Green>Program</font> <font color=Green>()</font>
  <font color=Green>Get</font>    <font color="#808080">::</font> <font color=Green>Program</font> <font color="#808080">(</font><font color=Green>Maybe</font> <font color=Green>Char</font><font color="#808080">)</font>
  <font color=Green>Return</font> <font color="#808080">::</font> a <font color="#808080">-&gt;</font> <font color=Green>Program</font> a
  <font color="#808080">(</font><b><font color="#800080">:&gt;&gt;=</font></b><font color="#808080">)</font> <font color="#808080">::</font> <font color=Green>Program</font> a <font color="#808080">-&gt;</font> <font color="#808080">(</font>a <font color="#808080">-&gt;</font> <font color=Green>Program</font> b<font color="#808080">)</font> <font color="#808080">-&gt;</font> <font color=Green>Program</font> b

<u><font color="#804000">type</font></u> <font color=Green>IOSem</font> a <font color="#808080">=</font> <font color=Green>Input</font>  <font color="#808080">-&gt;</font> <font color="#808080">(</font>a<font color="#808080">,</font> <font color=Green>Input</font><font color="#808080">,</font> <font color=Green>Output</font><font color="#808080">)</font>
<font color=Blue>-- | run function: translate syntax to semantics</font>
run <font color="#808080">::</font> <font color=Green>Program</font> a <font color="#808080">-&gt;</font> <font color=Green>IOSem</font> a
run <font color="#808080">(</font><font color=Green>Put</font> c<font color="#808080">)</font>  inp       <font color="#808080">=</font> <font color="#808080">(</font><font color=Green>()</font><font color="#808080">,</font> inp<font color="#808080">,</font> <font color="#808080">[</font>c<font color="#808080">]</font><font color="#808080">)</font>
run <font color=Green>Get</font>      <font color="#808080">(</font>c<b><font color="#800080">:</font></b>rest<font color="#808080">)</font>  <font color="#808080">=</font> <font color="#808080">(</font><font color=Green>Just</font> c <font color="#808080">,</font> rest<font color="#808080">,</font> <font color=Green>[]</font><font color="#808080">)</font>
run <font color=Green>Get</font>      <font color=Green>[]</font>        <font color="#808080">=</font> <font color="#808080">(</font><font color=Green>Nothing</font><font color="#808080">,</font> <font color=Green>[]</font>  <font color="#808080">,</font> <font color=Green>[]</font><font color="#808080">)</font>
run <font color="#808080">(</font><font color=Green>Return</font> x<font color="#808080">)</font> inp     <font color="#808080">=</font> <font color="#808080">(</font>x<font color="#808080">,</font>inp<font color="#808080">,</font><font color=Green>[]</font><font color="#808080">)</font>
run <font color="#808080">(</font>p <b><font color="#800080">:&gt;&gt;=</font></b> f<font color="#808080">)</font> inp     <font color="#808080">=</font> <font color="#808080">(</font>retb<font color="#808080">,</font> inp3<font color="#808080">,</font> out2 <font color="#800080">++</font> out3<font color="#808080">)</font>
  <u><font color="#804000">where</font></u> <font color="#808080">(</font>reta<font color="#808080">,</font> inp2<font color="#808080">,</font> out2<font color="#808080">)</font> <font color="#808080">=</font> run p inp
        step3<font color="#808080">@</font><font color="#808080">(</font>retb<font color="#808080">,</font> inp3<font color="#808080">,</font> out3<font color="#808080">)</font> <font color="#808080">=</font> run <font color="#808080">(</font>f reta<font color="#808080">)</font> inp2
<font color=Blue>-- p :: Program a</font>
<font color=Blue>-- f :: a -&gt; Program b        </font>
<font color=Blue>-- inp :: Input = String        </font>

example1 <font color="#808080">::</font> <font color=Green>Program</font> <font color=Green>()</font>
example1 <font color="#808080">=</font> <font color=Green>Put</font> <font color=Magenta>'a'</font>

example2 <font color="#808080">=</font> <font color=Green>Get</font> <font color="#800080">&gt;&gt;=</font> f
  <u><font color="#804000">where</font></u> f <font color=Green>Nothing</font>  <font color="#808080">=</font> example1
        f <font color="#808080">(</font><font color=Green>Just</font> c<font color="#808080">)</font> <font color="#808080">=</font> <font color=Green>Put</font> c <font color="#800080">&gt;&gt;</font> <font color=Green>Put</font> c

<u><font color="#804000">instance</font></u> <font color=Green>Monad</font> <font color=Green>Program</font> <u><font color="#804000">where</font></u>
  return  <font color="#808080">=</font>  <font color=Green>Return</font>
  <font color="#808080">(</font><font color="#800080">&gt;&gt;=</font><font color="#808080">)</font>   <font color="#808080">=</font>  <font color="#808080">(</font><b><font color="#800080">:&gt;&gt;=</font></b><font color="#808080">)</font>


<font color=Blue>{-

-- | The trivial deep embedding. We need to use a GADT to be allowed
--   the specific types on 'Get' and 'Put'.
data Program a where
  Put    :: Char -&gt; Program ()
  Get    :: Program (Maybe Char)  -- (Nothing) signals "end of input"
  Return :: a -&gt; Program a
  (:&gt;&gt;=) :: Program a -&gt; (a -&gt; Program b) -&gt; Program b

type IOSem a = Input -&gt; (a, Input, Output)
-- | run function: translate syntax to semantics
run :: Program a -&gt; IOSem a
run (Put c)     i        =  ((),       i,   [c])
run Get         []       =  (Nothing,  [],  [])
run Get         (c : i)  =  (Just c,   i,   [])

run (Return x)  i        =  (x,        i,   [])
run (p :&gt;&gt;= f)  i        =  (y,        i2,  o1 ++ o2) 
  where  (x,  i1,  o1)   =  run p i
         (y,  i2,  o2)   =  run (f x) i1

instance Monad Program where
  return  =  Return
  (&gt;&gt;=)   =  (:&gt;&gt;=)
  -- fail has no natural definition for the (Program a) datatype

-- | Output a character.
putC :: Char -&gt; Program ()
putC = Put

-- | Input a character.
getC :: Program (Maybe Char)
getC = Get
-}</font></pre>
</body>
</html>