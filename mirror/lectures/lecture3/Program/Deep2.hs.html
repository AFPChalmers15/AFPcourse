<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>lectures/lecture3/Program/Deep2.hs</title>
</head>
<body>
<pre><font color=Blue>{-|
  A simple embedded language for input/output. Intermediate emb.
-}</font>
<u><font color="#804000">module</font></u> <font color=Green>Program</font><font color="#800080">.</font><font color=Green>Deep2</font> <u><font color="#804000">where</font></u>
<u><font color="#804000">import</font></u> <font color=Green>Control</font><font color="#800080">.</font><font color=Green>Monad</font><font color="#808080">(</font><font color="#808080">(</font><font color="#800080">&gt;=&gt;</font><font color="#808080">)</font><font color="#808080">)</font>

<u><font color="#804000">type</font></u> <font color=Green>Input</font>   <font color="#808080">=</font>  <font color=Green>String</font>
<u><font color="#804000">type</font></u> <font color=Green>Output</font>  <font color="#808080">=</font>  <font color=Green>String</font>

<font color=Blue>{-

It is often good to move away a bit from the pure deep embedding
towards some kind of "normal form". In our case we can start by
looking at how Put and Get can be used. The only combinator in our
language is Bind (&gt;&gt;=) so lets looks at the different cases for the
first argument to Bind. 

  Put &gt;&gt;= f

From the types of Put and Bind we note that f must have type 

  () -&gt; m a

which is basically just a value of type (m a). Another way to think
about it is that Put does not really return any useful value (the
actual "putting" is implemented as a "side-effect"). So the function
after bind can ignore its argument. The operator "then":

  (&gt;&gt;) :: Monad m =&gt; m a -&gt; m a -&gt; m a

can be used 

  Put c &gt;&gt;= \_ -&gt; p   ==   Put c &gt;&gt; p

We will now give a name to this new combination 

  PutThen c p  ==  Put c &gt;&gt; p

This is a Program which starts by printing c and the behaves like p.

In a similar way we can introduce a new name for the combination of
Get and Bind:

  GetBind f  ==  Get &gt;&gt;= f

The third combination would be ReturnBind

  ReturnBind x f  ==  Return x &gt;&gt;= f

but the first monad law already tells us that this is just (f x) so no
new constructor is needed for this combination.

Finally we would have the fourth combination (of Bind and Bind) but
that can also be simplified away (as we can see below). At this point
we will just define the new datatype, hoping that we can do without
Bind.

-}</font>

<u><font color="#804000">data</font></u> <font color=Green>Program</font> a <u><font color="#804000">where</font></u>
  <font color=Green>PutThen</font> <font color="#808080">::</font> <font color=Green>Char</font> <font color="#808080">-&gt;</font> <font color="#808080">(</font><font color=Green>Program</font> a<font color="#808080">)</font>       <font color="#808080">-&gt;</font> <font color=Green>Program</font> a
  <font color=Green>GetBind</font> <font color="#808080">::</font> <font color="#808080">(</font><font color=Green>Maybe</font> <font color=Green>Char</font> <font color="#808080">-&gt;</font> <font color=Green>Program</font> a<font color="#808080">)</font> <font color="#808080">-&gt;</font> <font color=Green>Program</font> a
  <font color=Green>Return</font>  <font color="#808080">::</font> a                         <font color="#808080">-&gt;</font> <font color=Green>Program</font> a

<font color=Blue>-- | It turns out that bind can still be defined!</font>
<u><font color="#804000">instance</font></u> <font color=Green>Monad</font> <font color=Green>Program</font> <u><font color="#804000">where</font></u>
  return  <font color="#808080">=</font> <font color=Green>Return</font>
  <font color="#808080">(</font><font color="#800080">&gt;&gt;=</font><font color="#808080">)</font>   <font color="#808080">=</font> bindP  

<font color=Blue>-- | Bind takes the first argument apart:</font>
bindP <font color="#808080">::</font> <font color=Green>Program</font> a <font color="#808080">-&gt;</font> <font color="#808080">(</font>a <font color="#808080">-&gt;</font> <font color=Green>Program</font> b<font color="#808080">)</font> <font color="#808080">-&gt;</font> <font color=Green>Program</font> b
bindP <font color="#808080">(</font><font color=Green>PutThen</font> c p<font color="#808080">)</font>  k   <font color="#808080">=</font>  <font color=Green>PutThen</font> c <font color="#808080">(</font>bindP p k<font color="#808080">)</font>
bindP <font color="#808080">(</font><font color=Green>GetBind</font> f<font color="#808080">)</font>    k   <font color="#808080">=</font>  <font color=Green>GetBind</font> <font color="#808080">(</font><font color="#808080">\</font>x <font color="#808080">-&gt;</font> bindP <font color="#808080">(</font>f x<font color="#808080">)</font> k<font color="#808080">)</font>
bindP <font color="#808080">(</font><font color=Green>Return</font> x<font color="#808080">)</font>     k   <font color="#808080">=</font>  k x

<font color=Blue>-- Alt. </font>
<font color=Blue>-- bindP (GetBind f)    k   =  GetBind (f &gt;=&gt; k)</font>

<font color=Blue>{-
  bindP (Return x)    k 
= Def. &gt;&gt;=
  (Return x) &gt;&gt;= k 
=  Law 1.  return x &gt;&gt;= f   ==  f x
  k x
-}</font>

<font color=Blue>{-
  bindP (GetBind f)   k
= Def. of (&gt;&gt;=)
  (GetBind f) &gt;&gt;=  k
= Def. GetBind  
  (Get &gt;&gt;= f) &gt;&gt;=  k
= Law 3.  (m &gt;&gt;= f) &gt;&gt;= g  ==  m &gt;&gt;= (\x -&gt; f x &gt;&gt;= g)
  with m = Get, f = f, g = k
  Get &gt;&gt;= (\x -&gt; f x &gt;&gt;= k)
= Def. GetBind  
  GetBind (\x -&gt; f x &gt;&gt;= k)
= Def. of (&gt;&gt;=)
  GetBind (\x -&gt; bindP (f x) k)
-}</font>
<font color=Blue>{-
  bindP (PutThen c p) k
= { Def. of (&gt;&gt;=) }
  (PutThen c p) &gt;&gt;= k
= { Def. of PutThen }
  (Put c &gt;&gt; p) &gt;&gt;= k
=   
  (Put c &gt;&gt;= \_ -&gt; p) &gt;&gt;= k
= Law3 with m = Put c, f = \_-&gt;p, g = k
  Put c &gt;&gt;= (\x -&gt; (\_-&gt;p) x &gt;&gt;= k)
= simplify  
  Put c &gt;&gt;= (\_ -&gt; p &gt;&gt;= k)
= Def. of &gt;&gt;
  Put c &gt;&gt; (p &gt;&gt;= k)
= Def. of PutThen  
  PutThen c (p &gt;&gt;= k)
-}</font>

<font color=Blue>--    Law 3.  (m &gt;&gt;= f) &gt;&gt;= g  ==  m &gt;&gt;= (\x -&gt; f x &gt;&gt;= g)</font>

<font color=Blue>{- We can *calculate* the correct definition of bindP using
   the follwing intuitive meaning of PutThen and GetBind

    @PutThen c p == putC c &gt;&gt; p@
    @GetBind f   == getC &gt;&gt;= f@

 and the monad laws:

    Law 1.  return x &gt;&gt;= f   ==  f x

    Law 2.  m &gt;&gt;= return     ==  m

    Law 3.  (m &gt;&gt;= f) &gt;&gt;= g  ==  m &gt;&gt;= (\x -&gt; f x &gt;&gt;= g)
    Law 3'. (f &gt;=&gt; g) &gt;=&gt; h  ==  f &gt;=&gt; (g &gt;=&gt; h)
      -- Basically associativity of bind

   For instance,

      GetBind f &gt;&gt;= k             { meaning of GetBind }
  ==  (getC &gt;&gt;= f) &gt;&gt;= k          { third monad law }
  ==  getC &gt;&gt;= (\c -&gt; f c &gt;&gt;= k)  { meaning of GetBind }
  ==  GetBind (\c -&gt; f c &gt;&gt;= k)
  ==  GetBind (f &gt;=&gt; k)

-}</font>

<font color=Blue>-- &gt; (&gt;=&gt;) :: Monad m =&gt; (a -&gt; m b) -&gt; (b -&gt; m c) -&gt; (a -&gt; m c)</font>
<font color=Blue>-- &gt; f &gt;=&gt; g   =   \a -&gt;  f a &gt;&gt;= g</font>

<font color=Blue>-- Law 3'. (f &gt;=&gt; g) &gt;=&gt; h  ==  f &gt;=&gt; (g &gt;=&gt; h)</font>
<font color=Blue>-- Basically associativity of bind</font>

<font color=Blue>-- | Output a character.</font>
putC <font color="#808080">::</font> <font color=Green>Char</font> <font color="#808080">-&gt;</font> <font color=Green>Program</font> <font color=Green>()</font>
putC c <font color="#808080">=</font> <font color=Green>PutThen</font> c <font color="#800080">$</font> <font color=Green>Return</font> <font color=Green>()</font>

<font color=Blue>-- | Input a character.</font>
getC <font color="#808080">::</font> <font color=Green>Program</font> <font color="#808080">(</font><font color=Green>Maybe</font> <font color=Green>Char</font><font color="#808080">)</font>
getC <font color="#808080">=</font> <font color=Green>GetBind</font> <font color=Green>Return</font>


<u><font color="#804000">type</font></u> <font color=Green>IOSem</font> a <font color="#808080">=</font> <font color=Green>Input</font> <font color="#808080">-&gt;</font> <font color="#808080">(</font>a<font color="#808080">,</font> <font color=Green>Input</font><font color="#808080">,</font> <font color=Green>Output</font><font color="#808080">)</font>
<font color=Blue>-- | The run function is easier than before</font>
run <font color="#808080">::</font> <font color=Green>Program</font> a <font color="#808080">-&gt;</font> <font color=Green>IOSem</font> a
run <font color="#808080">(</font><font color=Green>PutThen</font> c p<font color="#808080">)</font>  i        <font color="#808080">=</font>  <font color="#808080">(</font>x<font color="#808080">,</font>  i'<font color="#808080">,</font>  c <b><font color="#800080">:</font></b> o<font color="#808080">)</font>
  <u><font color="#804000">where</font></u> <font color="#808080">(</font>x<font color="#808080">,</font> i'<font color="#808080">,</font> o<font color="#808080">)</font>  <font color="#808080">=</font>  run p i
run <font color="#808080">(</font><font color=Green>GetBind</font> f<font color="#808080">)</font>    <font color=Green>[]</font>       <font color="#808080">=</font>  run <font color="#808080">(</font>f <font color=Green>Nothing</font><font color="#808080">)</font>   <font color=Green>[]</font>
run <font color="#808080">(</font><font color=Green>GetBind</font> f<font color="#808080">)</font>    <font color="#808080">(</font>c <b><font color="#800080">:</font></b> i<font color="#808080">)</font>  <font color="#808080">=</font>  run <font color="#808080">(</font>f <font color="#800080">$</font> <font color=Green>Just</font> c<font color="#808080">)</font>  i
run <font color="#808080">(</font><font color=Green>Return</font> x<font color="#808080">)</font>     i        <font color="#808080">=</font>  <font color="#808080">(</font>x<font color="#808080">,</font>  i<font color="#808080">,</font>  <font color=Green>[]</font><font color="#808080">)</font>
</pre>
</body>
</html>