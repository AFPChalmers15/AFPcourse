<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>lectures/lecture3/Game.hs</title>
</head>
<body>
<pre><font color=Blue>{-
  A simple game engine for ascii games.
-}</font>
<u><font color="#804000">module</font></u> <font color=Green>Game</font> <font color="#808080">(</font><font color=Green>Game</font><font color="#808080">,</font> runGame<font color="#808080">)</font> <u><font color="#804000">where</font></u>

<u><font color="#804000">import</font></u> <font color=Green>System</font><font color="#800080">.</font><font color=Green>Posix</font><font color="#808080">(</font>usleep<font color="#808080">)</font>
<u><font color="#804000">import</font></u> <font color=Green>System</font><font color="#800080">.</font><font color=Green>IO</font><font color="#808080">(</font>stdin<font color="#808080">,</font> stdout<font color="#808080">,</font> hSetBuffering<font color="#808080">,</font> <font color=Green>BufferMode</font><font color="#808080">(</font><font color=Green>NoBuffering</font><font color="#808080">)</font><font color="#808080">,</font> hSetEcho<font color="#808080">)</font>

<u><font color="#804000">import</font></u> <font color=Green>ANSI</font><font color="#808080">(</font>ansiGoto<font color="#808080">,</font> ansiClearScreen<font color="#808080">)</font>
<u><font color="#804000">import</font></u> <font color=Green>Program</font><font color="#808080">(</font><font color=Green>Program</font><font color="#808080">,</font> runIONonBlocking<font color="#808080">)</font>

<font color=Blue>-- | A game with state s is a program which given a game state computes the</font>
<font color=Blue>--   next state, doing some input/output in the process.</font>
<font color=Blue>-- 'Nothing' represents the end of the game.</font>
<u><font color="#804000">type</font></u> <font color=Green>Game</font> s <font color="#808080">=</font> s <font color="#808080">-&gt;</font> <font color=Green>Program</font> <font color="#808080">(</font><font color=Green>Maybe</font> s<font color="#808080">)</font>

<font color=Blue>-- | Run a game with a given delay between each states.</font>
gameLoop <font color="#808080">::</font> <font color=Green>Float</font> <font color="#808080">-&gt;</font> <font color=Green>Game</font> s <font color="#808080">-&gt;</font> s <font color="#808080">-&gt;</font> <font color=Green>IO</font> <font color=Green>()</font>
gameLoop dt step st <font color="#808080">=</font> <u><font color="#804000">do</font></u>
  r <font color="#808080">&lt;-</font> runIONonBlocking <font color="#808080">(</font>step st<font color="#808080">)</font>
  <u><font color="#804000">case</font></u> r <u><font color="#804000">of</font></u>
    <font color=Green>Nothing</font>   <font color="#808080">-&gt;</font> return <font color=Green>()</font>
    <font color=Green>Just</font> st'  <font color="#808080">-&gt;</font> <u><font color="#804000">do</font></u>
      usleep <font color="#808080">(</font>round <font color="#800080">$</font> dt <font color="#800080">*</font> <font color=Magenta>1000000</font><font color="#808080">)</font>
      gameLoop dt step st'

<font color=Blue>-- | Top-level function for running a game.</font>
runGame <font color="#808080">::</font> <font color=Green>Float</font> <font color="#808080">-&gt;</font> <font color=Green>Game</font> s <font color="#808080">-&gt;</font> s <font color="#808080">-&gt;</font> <font color=Green>IO</font> <font color=Green>()</font>
runGame dt step st <font color="#808080">=</font> <u><font color="#804000">do</font></u>
  putStr ansiClearScreen
  hSetBuffering stdin  <font color=Green>NoBuffering</font> <font color=Blue>-- Don't wait for newline when reading from stdin</font>
  hSetBuffering stdout <font color=Green>NoBuffering</font> <font color=Blue>-- Don't wait when writing either</font>
  hSetEcho stdin <font color=Green>False</font>             <font color=Blue>-- Don't echo characters on stdin</font>
  gameLoop dt step st
  hSetEcho stdin <font color=Green>True</font>              <font color=Blue>-- Turn echo back on.</font>
  putStr <font color="#800080">$</font> ansiGoto <font color=Magenta>1</font> <font color=Magenta>30</font>
</pre>
</body>
</html>