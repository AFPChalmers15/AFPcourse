<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>lectures/lecture4/exe/Example.hs</title>
</head>
<body>
<pre><u><font color="#804000">module</font></u> <font color=Green>Main</font> <u><font color="#804000">where</font></u>
<u><font color="#804000">import</font></u> <font color=Green>Test</font><font color="#800080">.</font><font color=Green>QuickCheck</font><font color=Blue>{- (Arbitrary(arbitrary), Gen,
                         sized, elements, frequency, 
                         quickCheck, sample) -}</font>
<u><font color="#804000">import</font></u> <font color=Green>Control</font><font color="#800080">.</font><font color=Green>Monad</font><font color="#808080">(</font>liftM<font color="#808080">,</font> liftM2<font color="#808080">)</font>
<u><font color="#804000">import</font></u> <font color=Green>ParseUtil</font> <font color=Blue>-- (P, symbol, pfail, (+++), parse, ...)</font>
<u><font color="#804000">import</font></u> <font color=Green>Lemmas</font>

<font color=Blue>-- | A very simple expression type.</font>
<u><font color="#804000">data</font></u> <font color=Green>Expr</font> <font color="#808080">=</font> <font color=Green>Lit</font> <font color=Green>Int</font> <font color="#808080">|</font> <font color=Green>Plus</font> <font color=Green>Expr</font> <font color=Green>Expr</font>
  <u><font color="#804000">deriving</font></u> <font color="#808080">(</font><font color=Green>Eq</font><font color="#808080">)</font>
<font color=Blue>--  deriving (Eq, Show) -- for debugging</font>

<font color=Blue>-- | A parser for expressions. E ::= T | T '+' E  </font>
<font color=Blue>--                                =  T ( empty | '+' E)</font>
<font color=Blue>--                                =  T ('+' T)*</font>
<font color=Blue>{-
-- | One of many possible variants (this associates (+) to the right
-- which is not quite correct if Expr should be a subset of Haskell)

exprP :: P Char Expr
exprP = do t &lt;- termP
           maybeParsePlusExpr t
  where maybeParsePlusExpr :: Expr -&gt; P Char Expr
        maybeParsePlusExpr t = 
          return t +++ 
          do this '+'
             e &lt;- exprP
             return (t `Plus` e)
-}</font>

<font color=Blue>-- | A parser for terms.       T ::= int | '(' E ')'</font>
termP <font color="#808080">::</font> <font color=Green>P</font> <font color=Green>Char</font> <font color=Green>Expr</font>
termP <font color="#808080">=</font> 
  <font color="#808080">(</font><u><font color="#804000">do</font></u> d <font color="#808080">&lt;-</font> digitP 
      return <font color="#808080">(</font><font color=Green>Lit</font> d<font color="#808080">)</font><font color="#808080">)</font>
   <font color="#800080">+++</font> 
  <u><font color="#804000">do</font></u> this <font color=Magenta>'('</font>
     e <font color="#808080">&lt;-</font> exprP
     this <font color=Magenta>')'</font>
     return e

test1 <font color="#808080">::</font> <font color="#808080">[</font><font color="#808080">(</font><font color=Green>Expr</font><font color="#808080">,</font> <font color=Green>String</font><font color="#808080">)</font><font color="#808080">]</font>
test1 <font color="#808080">=</font> parse exprP <font color=Magenta>"1+2+"</font>

q1 <font color="#808080">=</font> <font color="#808080">[</font> <font color="#808080">(</font><font color=Green>Lit</font> <font color=Magenta>1</font><font color="#808080">,</font>                               <font color=Magenta>"+2+3"</font><font color="#808080">)</font>
     <font color="#808080">,</font> <font color="#808080">(</font><font color=Green>Plus</font> <font color="#808080">(</font><font color=Green>Lit</font> <font color=Magenta>1</font><font color="#808080">)</font> <font color="#808080">(</font><font color=Green>Lit</font> <font color=Magenta>2</font><font color="#808080">)</font><font color="#808080">,</font>                  <font color=Magenta>"+3"</font><font color="#808080">)</font>
     <font color="#808080">,</font> <font color="#808080">(</font><font color=Green>Plus</font> <font color="#808080">(</font><font color=Green>Lit</font> <font color=Magenta>1</font><font color="#808080">)</font> <font color="#808080">(</font><font color=Green>Plus</font> <font color="#808080">(</font><font color=Green>Lit</font> <font color=Magenta>2</font><font color="#808080">)</font> <font color="#808080">(</font><font color=Green>Lit</font> <font color=Magenta>3</font><font color="#808080">)</font><font color="#808080">)</font><font color="#808080">,</font>     <font color=Magenta>""</font><font color="#808080">)</font>
     <font color="#808080">]</font>

<font color=Blue>-- [ (Lit 1, "+2+")</font>
<font color=Blue>-- , (Plus (Lit 1) (Lit 2),"+")</font>
<font color=Blue>-- ]</font>

























exprP <font color="#808080">::</font> <font color=Green>P</font> <font color=Green>Char</font> <font color=Green>Expr</font>
exprP <font color="#808080">=</font> <u><font color="#804000">do</font></u> e <font color="#808080">&lt;-</font> termP 
           maybeSomeMoreAfter e
  <u><font color="#804000">where</font></u> maybeSomeMoreAfter e1 <font color="#808080">=</font> return e1 <font color="#800080">+++</font> <u><font color="#804000">do</font></u>           
          this <font color=Magenta>'+'</font>
          e2 <font color="#808080">&lt;-</font> termP
          maybeSomeMoreAfter <font color="#808080">(</font><font color=Green>Plus</font> e1 e2<font color="#808080">)</font>

<font color=Blue>{-
exprP :: P Char Expr
exprP = chainLeft plusP termP
  where
    -- Parse the plus sign. Returns the 'Plus' function.
    plusP :: P Char (Expr -&gt; Expr -&gt; Expr)
    plusP = this '+' &gt;&gt; return Plus

termP :: P Char Expr
termP = liftM Lit digitP +++ do
  this '('
  e &lt;- exprP
  this ')'
  return e

-}</font>



<font color=Blue>-- | We test that showing and then parsing is the identity and </font>
<font color=Blue>--   that the parse is unambiguous.</font>
prop_parse <font color="#808080">::</font> <font color=Green>Expr</font> <font color="#808080">-&gt;</font> <font color=Green>Bool</font>
prop_parse e <font color="#808080">=</font> <font color="#808080">[</font>e<font color="#808080">]</font> <font color="#800080">==</font> parseAll <font color="#808080">(</font>show e<font color="#808080">)</font>
  <u><font color="#804000">where</font></u>
    <font color=Blue>-- Throw away incomplete parses</font>
    parseAll <font color="#808080">::</font> <font color=Green>String</font> <font color="#808080">-&gt;</font> <font color="#808080">[</font><font color=Green>Expr</font><font color="#808080">]</font>
    parseAll s <font color="#808080">=</font> <font color="#808080">[</font> x <font color="#808080">|</font> <font color="#808080">(</font>x<font color="#808080">,</font> <font color=Magenta>""</font><font color="#808080">)</font> <font color="#808080">&lt;-</font> parse exprP s <font color="#808080">]</font>
<font color=Blue>-- Bad:   </font>
<font color=Blue>--    parseAll s = [ x | (x, _) &lt;- parse exprP s ]</font>

runTests <font color="#808080">=</font> quickCheck prop_parse
              

main <font color="#808080">=</font> runTests

<font color=Blue>-- quickCheck (\(Blind f) s -&gt; concatMapSingletonLemma f s)</font>

<font color=Blue>---------------------------</font>
<font color=Blue>-- * Testing infrastructure</font>

<u><font color="#804000">instance</font></u> <font color=Green>Show</font> <font color=Green>Expr</font> <u><font color="#804000">where</font></u>
  showsPrec p <font color="#808080">(</font><font color=Green>Lit</font> n<font color="#808080">)</font>      <font color="#808080">=</font> shows n
  showsPrec p <font color="#808080">(</font><font color=Green>Plus</font> e1 e2<font color="#808080">)</font> <font color="#808080">=</font> showParen <font color="#808080">(</font>p <font color="#800080">&gt;</font> <font color=Magenta>0</font><font color="#808080">)</font> <font color="#800080">$</font>
    shows e1 <font color="#800080">.</font> showString <font color=Magenta>"+"</font> <font color="#800080">.</font> showsPrec <font color=Magenta>1</font> e2
<font color=Blue>-- | For reference:</font>
<font color=Blue>-- &gt; shows = showsPrec 0</font>


<u><font color="#804000">type</font></u> <font color=Green>Size</font> <font color="#808080">=</font> <font color=Green>Int</font>
<font color=Blue>-- | Generating arbitrary expressions.</font>
<u><font color="#804000">instance</font></u> <font color=Green>Arbitrary</font> <font color=Green>Expr</font> <u><font color="#804000">where</font></u>
  arbitrary <font color="#808080">=</font> sized arb
    <u><font color="#804000">where</font></u>
      digit <font color="#808080">::</font> <font color=Green>Gen</font> <font color=Green>Int</font>
      digit <font color="#808080">=</font> elements <font color="#808080">[</font><font color=Magenta>0</font><font color="#808080">..</font><font color=Magenta>9</font><font color="#808080">]</font>
      arb <font color="#808080">::</font> <font color=Green>Size</font> <font color="#808080">-&gt;</font> <font color=Green>Gen</font> <font color=Green>Expr</font>
      arb <font color=Magenta>0</font> <font color="#808080">=</font> liftM <font color=Green>Lit</font> digit
      arb n <font color="#808080">=</font> frequency <font color="#800080">$</font>
          <font color="#808080">(</font><font color=Magenta>1</font><font color="#808080">,</font> arb <font color=Magenta>0</font><font color="#808080">)</font> <b><font color="#800080">:</font></b>
        <font color="#808080">[</font> <font color="#808080">(</font><font color=Magenta>4</font><font color="#808080">,</font> liftM2 <font color=Green>Plus</font> arb2 arb2<font color="#808080">)</font> <font color="#808080">|</font> n <font color="#800080">&gt;</font> <font color=Magenta>0</font> <font color="#808080">]</font>
        <u><font color="#804000">where</font></u>
          arb2 <font color="#808080">::</font> <font color=Green>Gen</font> <font color=Green>Expr</font>
          arb2 <font color="#808080">=</font> arb <font color="#808080">(</font>n <font color="#800080">`div`</font> <font color=Magenta>2</font><font color="#808080">)</font>

</pre>
</body>
</html>