<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>lectures/lecture11/Array/Properties.hs</title>
</head>
<body>
<pre><font color=Blue>{-# LANGUAGE GeneralizedNewtypeDeriving #-}</font>
<u><font color="#804000">module</font></u> <font color=Green>Array</font><font color="#800080">.</font><font color=Green>Properties</font> <u><font color="#804000">where</font></u>
<u><font color="#804000">import</font></u> <font color=Green>Array</font>
<u><font color="#804000">import</font></u> <font color=Green>Array</font><font color="#800080">.</font><font color=Green>ShowInstances</font>
<u><font color="#804000">import</font></u> <font color=Green>Array</font><font color="#800080">.</font><font color=Green>EqInstances</font>
<u><font color="#804000">import</font></u> <font color=Green>Test</font><font color="#800080">.</font><font color=Green>QuickCheck</font>
<u><font color="#804000">import</font></u> <font color=Green>Control</font><font color="#800080">.</font><font color=Green>Monad</font><font color="#808080">(</font>liftM<font color="#808080">)</font>

prop_L1 <font color="#808080">::</font> <font color="#808080">(</font><font color=Green>ArrayElem</font> a<font color="#808080">,</font> <font color=Green>Eq</font> a<font color="#808080">)</font> <font color="#808080">=&gt;</font> <font color="#808080">[</font>a<font color="#808080">]</font> <font color="#808080">-&gt;</font> <font color=Green>Property</font>
prop_L1 xs <font color="#808080">=</font> not <font color="#808080">(</font>null xs<font color="#808080">)</font> <font color="#800080">==&gt;</font>
  forAll <font color="#808080">(</font>choose <font color="#808080">(</font><font color=Magenta>0</font><font color="#808080">,</font> length xs <font color=Blue>-</font> <font color=Magenta>1</font><font color="#808080">)</font><font color="#808080">)</font> <font color="#800080">$</font> <font color="#808080">\</font>i <font color="#808080">-&gt;</font>
    fromList xs <font color="#800080">!</font> <font color="#808080">(</font><font color=Green>Index</font> i<font color="#808080">)</font>  <font color="#800080">==</font>  xs <font color="#800080">!!</font> i

testL1Int  <font color="#808080">=</font> quickCheck <font color="#808080">(</font>prop_L1 <font color="#808080">::</font> <font color="#808080">[</font><font color=Green>Int</font><font color="#808080">]</font>       <font color="#808080">-&gt;</font> <font color=Green>Property</font><font color="#808080">)</font>
testL1Pair <font color="#808080">=</font> quickCheck <font color="#808080">(</font>prop_L1 <font color="#808080">::</font> <font color="#808080">[</font><font color="#808080">(</font><font color=Green>Int</font><font color="#808080">,</font><font color=Green>Int</font><font color="#808080">)</font><font color="#808080">]</font> <font color="#808080">-&gt;</font> <font color=Green>Property</font><font color="#808080">)</font>
testL1Nest <font color="#808080">=</font> quickCheck <font color="#808080">(</font>prop_L1 <font color="#808080">::</font> <font color="#808080">[</font><font color=Green>Array</font> <font color=Green>Int</font><font color="#808080">]</font> <font color="#808080">-&gt;</font> <font color=Green>Property</font><font color="#808080">)</font>

prop_L2 <font color="#808080">::</font> <font color="#808080">(</font><font color=Green>ArrayElem</font> a<font color="#808080">,</font> <font color=Green>Eq</font> a<font color="#808080">)</font> <font color="#808080">=&gt;</font> <font color="#808080">[</font>a<font color="#808080">]</font> <font color="#808080">-&gt;</font> <font color=Green>Bool</font>
prop_L2 xs <font color="#808080">=</font> toList <font color="#808080">(</font>fromList xs<font color="#808080">)</font> <font color="#800080">==</font> xs

testL2Int  <font color="#808080">=</font> quickCheck <font color="#808080">(</font>prop_L2 <font color="#808080">::</font> <font color="#808080">[</font><font color=Green>Int</font><font color="#808080">]</font> <font color="#808080">-&gt;</font> <font color=Green>Bool</font><font color="#808080">)</font>
testL2Pair <font color="#808080">=</font> quickCheck <font color="#808080">(</font>prop_L2 <font color="#808080">::</font> <font color="#808080">[</font><font color="#808080">(</font><font color=Green>Int</font><font color="#808080">,</font><font color=Green>Int</font><font color="#808080">)</font><font color="#808080">]</font> <font color="#808080">-&gt;</font> <font color=Green>Bool</font><font color="#808080">)</font>
testL2Nest <font color="#808080">=</font> quickCheck <font color="#808080">(</font>prop_L2 <font color="#808080">::</font> <font color="#808080">[</font><font color=Green>Array</font> <font color=Green>Int</font><font color="#808080">]</font> <font color="#808080">-&gt;</font> <font color=Green>Bool</font><font color="#808080">)</font>

sliceModel <font color="#808080">::</font> <font color="#808080">[</font>a<font color="#808080">]</font> <font color="#808080">-&gt;</font> <font color="#808080">(</font><font color=Green>Index</font><font color="#808080">,</font> <font color=Green>Size</font><font color="#808080">)</font> <font color="#808080">-&gt;</font> <font color="#808080">[</font>a<font color="#808080">]</font>
sliceModel xs <font color="#808080">(</font><font color=Green>Index</font> i<font color="#808080">,</font> <font color=Green>Size</font> n<font color="#808080">)</font> <font color="#808080">=</font> take n <font color="#808080">(</font>drop i xs<font color="#808080">)</font>
toModel <font color="#808080">::</font> <font color=Green>ArrayElem</font> a <font color="#808080">=&gt;</font> <font color=Green>Array</font> a <font color="#808080">-&gt;</font> <font color="#808080">[</font>a<font color="#808080">]</font>
toModel <font color="#808080">=</font> toList

<font color="#808080">(</font><font color="#800080">~=</font><font color="#808080">)</font> <font color="#808080">::</font> <font color="#808080">(</font><font color=Green>ArrayElem</font> a<font color="#808080">,</font> <font color=Green>Eq</font> a<font color="#808080">)</font> <font color="#808080">=&gt;</font> <font color="#808080">[</font>a<font color="#808080">]</font> <font color="#808080">-&gt;</font> <font color=Green>Array</font> a <font color="#808080">-&gt;</font> <font color=Green>Bool</font>
model <font color="#800080">~=</font> impl  <font color="#808080">=</font>  model <font color="#800080">==</font> toModel impl

prop_L3 <font color="#808080">::</font> <font color="#808080">(</font><font color=Green>ArrayElem</font> a<font color="#808080">,</font> <font color=Green>Eq</font> a<font color="#808080">)</font> <font color="#808080">=&gt;</font> <font color="#808080">[</font>a<font color="#808080">]</font> <font color="#808080">-&gt;</font> <font color="#808080">(</font><font color=Green>Index</font><font color="#808080">,</font> <font color=Green>Size</font><font color="#808080">)</font> <font color="#808080">-&gt;</font> <font color=Green>Bool</font>
prop_L3 xs p <font color="#808080">=</font> sliceModel xs p <font color="#800080">~=</font> slice <font color="#808080">(</font>fromList xs<font color="#808080">)</font> p

q <font color="#808080">::</font> <font color="#808080">(</font><font color=Green>Testable</font> prop<font color="#808080">)</font> <font color="#808080">=&gt;</font> prop <font color="#808080">-&gt;</font> <font color=Green>IO</font> <font color=Green>()</font>
q <font color="#808080">=</font> quickCheck

testL3Int  <font color="#808080">=</font> q <font color="#808080">(</font>prop_L3 <font color="#808080">::</font> <font color="#808080">[</font><font color=Green>Int</font><font color="#808080">]</font>       <font color="#808080">-&gt;</font> <font color="#808080">(</font><font color=Green>Index</font><font color="#808080">,</font> <font color=Green>Size</font><font color="#808080">)</font> <font color="#808080">-&gt;</font> <font color=Green>Bool</font><font color="#808080">)</font>
testL3Pair <font color="#808080">=</font> q <font color="#808080">(</font>prop_L3 <font color="#808080">::</font> <font color="#808080">[</font><font color="#808080">(</font><font color=Green>Int</font><font color="#808080">,</font><font color=Green>Int</font><font color="#808080">)</font><font color="#808080">]</font> <font color="#808080">-&gt;</font> <font color="#808080">(</font><font color=Green>Index</font><font color="#808080">,</font> <font color=Green>Size</font><font color="#808080">)</font> <font color="#808080">-&gt;</font> <font color=Green>Bool</font><font color="#808080">)</font>
testL3Nest <font color="#808080">=</font> q <font color="#808080">(</font>prop_L3 <font color="#808080">::</font> <font color="#808080">[</font><font color=Green>Array</font> <font color=Green>Int</font><font color="#808080">]</font> <font color="#808080">-&gt;</font> <font color="#808080">(</font><font color=Green>Index</font><font color="#808080">,</font> <font color=Green>Size</font><font color="#808080">)</font> <font color="#808080">-&gt;</font> <font color=Green>Bool</font><font color="#808080">)</font>

<u><font color="#804000">instance</font></u> <font color="#808080">(</font><font color=Green>Arbitrary</font> a<font color="#808080">,</font> <font color=Green>ArrayElem</font> a<font color="#808080">)</font> <font color="#808080">=&gt;</font> <font color=Green>Arbitrary</font> <font color="#808080">(</font><font color=Green>Array</font> a<font color="#808080">)</font> <u><font color="#804000">where</font></u>
  arbitrary <font color="#808080">=</font> liftM fromList arbitrary

<u><font color="#804000">instance</font></u> <font color=Green>Arbitrary</font> <font color=Green>Index</font> <u><font color="#804000">where</font></u> <font color=Blue>-- no negative indices</font>
  arbitrary <font color="#808080">=</font> liftM <font color=Green>Index</font> <font color="#800080">$</font> sized <font color="#808080">(</font><font color="#808080">\</font>n<font color="#808080">-&gt;</font> choose <font color="#808080">(</font><font color=Magenta>0</font><font color="#808080">,</font>n<font color="#808080">)</font><font color="#808080">)</font> 

<u><font color="#804000">instance</font></u> <font color=Green>Arbitrary</font> <font color=Green>Size</font> <u><font color="#804000">where</font></u> <font color=Blue>-- no negative sizes</font>
  arbitrary <font color="#808080">=</font> liftM <font color=Green>Size</font> <font color="#800080">$</font> sized <font color="#808080">(</font><font color="#808080">\</font>n<font color="#808080">-&gt;</font> choose <font color="#808080">(</font><font color=Magenta>0</font><font color="#808080">,</font>n<font color="#808080">)</font><font color="#808080">)</font> 

main <font color="#808080">=</font> sequence_ <font color="#808080">[</font> testL1Int<font color="#808080">,</font> testL1Pair<font color="#808080">,</font> testL1Nest
                 <font color="#808080">,</font> testL2Int<font color="#808080">,</font> testL2Pair<font color="#808080">,</font> testL2Nest
                 <font color="#808080">,</font> testL3Int<font color="#808080">,</font> testL3Pair<font color="#808080">,</font> testL3Nest
                 <font color="#808080">]</font>

<font color=Blue>{-
An earlier version had

*Array.Properties&gt; testL3Nest
*** Failed! Falsifiable (after 4 tests):                  
[ArrInt [2],ArrInt [-1,-2,-1]]
(Index 1,Size 1)

The problem was that slice for nested arrays did not preserve the
invariant that the ins :: Array (Index, Size) should satisfy.

In fact, it would be more convenient if the full sum (the element
dropped by init) was also stored.

-}</font>

test1l <font color="#808080">::</font> <font color="#808080">[</font><font color=Green>Array</font> <font color=Green>Int</font><font color="#808080">]</font>
test1l <font color="#808080">=</font> <font color="#808080">[</font><font color=Green>ArrInt</font> <font color="#808080">[</font><font color=Blue>-</font><font color=Magenta>2</font><font color="#808080">,</font><font color=Magenta>0</font><font color="#808080">]</font> <font color="#808080">,</font><font color=Green>ArrInt</font> <font color=Green>[]</font><font color="#808080">,</font><font color=Green>ArrInt</font> <font color="#808080">[</font><font color=Magenta>0</font><font color="#808080">]</font><font color="#808080">]</font>
test1a <font color="#808080">::</font> <font color=Green>Array</font> <font color="#808080">(</font><font color=Green>Array</font> <font color=Green>Int</font><font color="#808080">)</font>
test1a <font color="#808080">=</font> fromList test1l

<font color=Blue>-- Untested code - partial solution to the exercise.</font>
prop_invariant <font color="#808080">::</font> <font color="#808080">(</font><font color=Green>Eq</font> b<font color="#808080">,</font> <font color=Green>Num</font> b<font color="#808080">)</font> <font color="#808080">=&gt;</font> <font color="#808080">[</font><font color="#808080">(</font>b<font color="#808080">,</font> b<font color="#808080">)</font><font color="#808080">]</font> <font color="#808080">-&gt;</font> <font color=Green>Bool</font>
prop_invariant iss <font color="#808080">=</font> is <font color="#800080">==</font> init is'
  <u><font color="#804000">where</font></u> <font color="#808080">(</font>is<font color="#808080">,</font> ns<font color="#808080">)</font> <font color="#808080">=</font> unzip iss
        is' <font color="#808080">=</font> scanl <font color="#808080">(</font><font color="#800080">+</font><font color="#808080">)</font> <font color=Magenta>0</font> ns
</pre>
</body>
</html>