<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>lectures/lecture11/Typed.hs</title>
</head>
<body>
<pre><font color=Blue>{-# LANGUAGE GADTs, ExistentialQuantification #-}</font>
<u><font color="#804000">module</font></u> <font color=Green>Typed</font> <u><font color="#804000">where</font></u>

<u><font color="#804000">import</font></u> <u><font color="#804000">qualified</font></u> <font color=Green>Expr</font> <u><font color="#804000">as</font></u> <font color=Green>E</font>
<u><font color="#804000">import</font></u> <font color=Green>Data</font><font color="#800080">.</font><font color=Green>Maybe</font> <font color="#808080">(</font>fromJust<font color="#808080">,</font> isJust<font color="#808080">)</font>
<u><font color="#804000">import</font></u> <font color=Green>Expr</font><font color="#800080">.</font><font color=Green>Gen</font> <font color=Green>()</font>
<u><font color="#804000">import</font></u> <font color=Green>Test</font><font color="#800080">.</font><font color=Green>QuickCheck</font>
<u><font color="#804000">import</font></u> <font color=Green>Control</font><font color="#800080">.</font><font color=Green>Monad</font>

<u><font color="#804000">infixl</font></u> <font color=Magenta>6</font> <b><font color="#800080">:+</font></b>
<u><font color="#804000">infix</font></u>  <font color=Magenta>4</font> <b><font color="#800080">:==</font></b>
<u><font color="#804000">infix</font></u>  <font color=Magenta>0</font> <b><font color="#800080">:::</font></b>

<font color=Blue>-- | The type of well-typed expressions. There is no way to</font>
<font color=Blue>-- construct an ill-typed expression in this datatype.</font>
<u><font color="#804000">data</font></u> <font color=Green>Expr</font> t <u><font color="#804000">where</font></u>
  <font color=Green>LitI</font>  <font color="#808080">::</font> <font color=Green>Int</font>                           <font color="#808080">-&gt;</font> <font color=Green>Expr</font> <font color=Green>Int</font>
  <font color=Green>LitB</font>  <font color="#808080">::</font> <font color=Green>Bool</font>                          <font color="#808080">-&gt;</font> <font color=Green>Expr</font> <font color=Green>Bool</font>
  <font color="#808080">(</font><b><font color="#800080">:+</font></b><font color="#808080">)</font>  <font color="#808080">::</font>         <font color=Green>Expr</font> <font color=Green>Int</font> <font color="#808080">-&gt;</font> <font color=Green>Expr</font> <font color=Green>Int</font>  <font color="#808080">-&gt;</font> <font color=Green>Expr</font> <font color=Green>Int</font>
  <font color="#808080">(</font><b><font color="#800080">:==</font></b><font color="#808080">)</font> <font color="#808080">::</font> <font color=Green>Eq</font> t <font color="#808080">=&gt;</font> <font color=Green>Expr</font> t   <font color="#808080">-&gt;</font> <font color=Green>Expr</font> t    <font color="#808080">-&gt;</font> <font color=Green>Expr</font> <font color=Green>Bool</font>
  <font color=Green>If</font>    <font color="#808080">::</font> <font color=Green>Expr</font> <font color=Green>Bool</font> <font color="#808080">-&gt;</font> <font color=Green>Expr</font> t <font color="#808080">-&gt;</font> <font color=Green>Expr</font> t <font color="#808080">-&gt;</font> <font color=Green>Expr</font> t

<font color=Blue>-- | A type-safe evaluator. Much nicer now that we now that</font>
<font color=Blue>-- expressions are well-typed. No Value datatype needed, no</font>
<font color=Blue>-- extra constructors VInt, VBool.</font>
eval <font color="#808080">::</font> <font color=Green>Expr</font> t <font color="#808080">-&gt;</font> t
eval <font color="#808080">(</font><font color=Green>LitI</font> n<font color="#808080">)</font>     <font color="#808080">=</font>  n
eval <font color="#808080">(</font><font color=Green>LitB</font> b<font color="#808080">)</font>     <font color="#808080">=</font>  b
eval <font color="#808080">(</font>e1 <b><font color="#800080">:+</font></b> e2<font color="#808080">)</font>   <font color="#808080">=</font>  eval e1 <font color="#800080">+</font>  eval e2
eval <font color="#808080">(</font>e1 <b><font color="#800080">:==</font></b> e2<font color="#808080">)</font>  <font color="#808080">=</font>  eval e1 <font color="#800080">==</font> eval e2
eval <font color="#808080">(</font><font color=Green>If</font> b t e<font color="#808080">)</font>   <font color="#808080">=</font>  <u><font color="#804000">if</font></u> eval b <u><font color="#804000">then</font></u> eval t <u><font color="#804000">else</font></u> eval e

eOK <font color="#808080">::</font> <font color=Green>Expr</font> <font color=Green>Int</font>
eOK  <font color="#808080">=</font> <font color=Green>If</font> <font color="#808080">(</font><font color=Green>LitB</font> <font color=Green>False</font><font color="#808080">)</font> <font color="#808080">(</font><font color=Green>LitI</font> <font color=Magenta>1</font><font color="#808080">)</font> <font color="#808080">(</font><font color=Green>LitI</font> <font color=Magenta>2</font> <b><font color="#800080">:+</font></b> <font color=Green>LitI</font> <font color=Magenta>1736</font><font color="#808080">)</font>
<font color=Blue>-- eBad = If (LitB False) (LitI 1) (LitI 2 :+ LitB True)</font>

<font color=Blue>-- | We can forget that an expression is typed. For instance, to</font>
<font color=Blue>-- be able to reuse the pretty printer we already have.</font>
forget <font color="#808080">::</font> <font color=Green>Expr</font> t <font color="#808080">-&gt;</font> <font color=Green>E</font><font color="#800080">.</font><font color=Green>Expr</font>
forget e <font color="#808080">=</font> <u><font color="#804000">case</font></u> e <u><font color="#804000">of</font></u>
  <font color=Green>LitI</font> n      <font color="#808080">-&gt;</font> <font color=Green>E</font><font color="#800080">.</font><font color=Green>LitI</font> n
  <font color=Green>LitB</font> b      <font color="#808080">-&gt;</font> <font color=Green>E</font><font color="#800080">.</font><font color=Green>LitB</font> b
  e1 <b><font color="#800080">:+</font></b> e2    <font color="#808080">-&gt;</font> forget e1  <font color=Green>E</font><font color="#800080">.:+</font>   forget e2
  e1 <b><font color="#800080">:==</font></b> e2   <font color="#808080">-&gt;</font> forget e1  <font color=Green>E</font><font color="#800080">.:==</font>  forget e2
  <font color=Green>If</font> e1 e2 e3 <font color="#808080">-&gt;</font> <font color=Green>E</font><font color="#800080">.</font><font color=Green>If</font> <font color="#808080">(</font>forget e1<font color="#808080">)</font> <font color="#808080">(</font>forget e2<font color="#808080">)</font> <font color="#808080">(</font>forget e3<font color="#808080">)</font>

<u><font color="#804000">instance</font></u> <font color=Green>Show</font> <font color="#808080">(</font><font color=Green>Expr</font> t<font color="#808080">)</font> <u><font color="#804000">where</font></u>
  showsPrec p e <font color="#808080">=</font> showsPrec p <font color="#808080">(</font>forget e<font color="#808080">)</font>

<font color=Blue>-- How to go the other way, turning an untyped expression into a</font>
<font color=Blue>-- typed expression?</font>

<font color=Blue>-- Answer: we have to do type checking! Moreover, our type</font>
<font color=Blue>-- checker will have to convince the Haskell type checker to</font>
<font color=Blue>-- allow us to construct an element of Expr t from an untyped</font>
<font color=Blue>-- expression passing our type checker. In other words we are</font>
<font color=Blue>-- not writing a type checker for our own benefit, but to</font>
<font color=Blue>-- explain to GHC's type checker why a particular untyped term</font>
<font color=Blue>-- is really well-typed.</font>

<font color=Blue>-- | The types that an expression can have. Indexed by the</font>
<font color=Blue>-- corresponding Haskell type.</font>
<u><font color="#804000">data</font></u> <font color=Green>Type</font> t <u><font color="#804000">where</font></u>
  <font color=Green>TInt</font>  <font color="#808080">::</font> <font color=Green>Type</font> <font color=Green>Int</font>
  <font color=Green>TBool</font> <font color="#808080">::</font> <font color=Green>Type</font> <font color=Green>Bool</font>

<u><font color="#804000">instance</font></u> <font color=Green>Show</font> <font color="#808080">(</font><font color=Green>Type</font> t<font color="#808080">)</font> <u><font color="#804000">where</font></u>
  show <font color=Green>TInt</font>  <font color="#808080">=</font> <font color=Magenta>"Int"</font>
  show <font color=Green>TBool</font> <font color="#808080">=</font> <font color=Magenta>"Bool"</font>

<font color=Blue>-- | Well-typed expressions of some type are just pairs of</font>
<font color=Blue>-- expressions and types which agree on the Haskell type. The</font>
<font color=Blue>-- /forall/ builds an existential type (exercise: think about</font>
<font color=Blue>-- whether this makes sense).</font>
<u><font color="#804000">data</font></u> <font color=Green>TypedExpr</font> <font color="#808080">=</font> <u><font color="#804000">forall</font></u> t<font color="#800080">.</font> <font color=Green>Eq</font> t <font color="#808080">=&gt;</font>   <font color=Green>Expr</font> t <b><font color="#800080">:::</font></b> <font color=Green>Type</font> t

<font color=Blue>-- evalT :: TypedExpr -&gt; ?</font>
<font color=Blue>-- evalT (e ::: t) = eval e</font>

<u><font color="#804000">instance</font></u> <font color=Green>Show</font> <font color=Green>TypedExpr</font> <u><font color="#804000">where</font></u>
  show <font color="#808080">(</font>e <b><font color="#800080">:::</font></b> t<font color="#808080">)</font> <font color="#808080">=</font> show e <font color="#800080">++</font> <font color=Magenta>" :: "</font> <font color="#800080">++</font> show t

<font color=Blue>-- | When comparing two types it's not enough to just return a</font>
<font color=Blue>-- boolean.  Remember that we're trying to convince GHC's type</font>
<font color=Blue>-- checker that two types are equal, and just evaluating some</font>
<font color=Blue>-- arbitrary function to True isn't going to impress it.</font>
<font color=Blue>--</font>
<font color=Blue>--   Instead we define a type of proofs that two types @a@ and</font>
<font color=Blue>--   @b@ are equal.  The only way to prove two types equal is if</font>
<font color=Blue>--   they are in fact the same, and then the proof is</font>
<font color=Blue>--   Refl. Evaluating one of these proofs to 'Refl' will</font>
<font color=Blue>--   convince GHC's type checker that the two type arguments are</font>
<font color=Blue>--   indeed equal (how else could the proof be Refl?).</font>
<u><font color="#804000">data</font></u> <font color=Green>Equal</font> a b <u><font color="#804000">where</font></u>
  <font color=Green>Refl</font> <font color="#808080">::</font> <font color=Green>Equal</font> a a

<font color=Blue>-- | The type comparison function returns a proof that the types</font>
<font color=Blue>-- we compare are equal in the cases that they are.</font>
<font color="#808080">(</font><font color="#800080">=?=</font><font color="#808080">)</font> <font color="#808080">::</font> <font color=Green>Type</font> s <font color="#808080">-&gt;</font> <font color=Green>Type</font> t <font color="#808080">-&gt;</font> <font color=Green>Maybe</font> <font color="#808080">(</font><font color=Green>Equal</font> s t<font color="#808080">)</font>
<font color=Green>TInt</font>  <font color="#800080">=?=</font> <font color=Green>TInt</font>  <font color="#808080">=</font> <font color=Green>Just</font> <font color=Green>Refl</font>
<font color=Green>TBool</font> <font color="#800080">=?=</font> <font color=Green>TBool</font> <font color="#808080">=</font> <font color=Green>Just</font> <font color=Green>Refl</font>
<u><font color="#804000">_</font></u>     <font color="#800080">=?=</font> <u><font color="#804000">_</font></u>     <font color="#808080">=</font> <font color=Green>Nothing</font>

<font color=Blue>-- | Finally the type inference algorithm. We're making heavy</font>
<font color=Blue>-- use of the fact that pattern matching on a @Type t@ or an</font>
<font color=Blue>-- @Equal s t@ will tell GHC's type checker interesting things</font>
<font color=Blue>-- about @s@ and @t@.</font>
infer <font color="#808080">::</font> <font color=Green>E</font><font color="#800080">.</font><font color=Green>Expr</font> <font color="#808080">-&gt;</font> <font color=Green>Maybe</font> <font color=Green>TypedExpr</font>
infer e <font color="#808080">=</font> <u><font color="#804000">case</font></u> e <u><font color="#804000">of</font></u>
  <font color=Green>E</font><font color="#800080">.</font><font color=Green>LitI</font> n <font color="#808080">-&gt;</font> return <font color="#808080">(</font><font color=Green>LitI</font> n <b><font color="#800080">:::</font></b> <font color=Green>TInt</font><font color="#808080">)</font>

  <font color=Green>E</font><font color="#800080">.</font><font color=Green>LitB</font> b <font color="#808080">-&gt;</font> return <font color="#808080">(</font><font color=Green>LitB</font> b <b><font color="#800080">:::</font></b> <font color=Green>TBool</font><font color="#808080">)</font>

  r1 <font color=Green>E</font><font color="#800080">.:+</font> r2 <font color="#808080">-&gt;</font> <u><font color="#804000">do</font></u>
    e1 <b><font color="#800080">:::</font></b> <font color=Green>TInt</font>  <font color="#808080">&lt;-</font>  infer r1
    e2 <b><font color="#800080">:::</font></b> <font color=Green>TInt</font>  <font color="#808080">&lt;-</font>  infer r2
    return <font color="#808080">(</font>e1 <b><font color="#800080">:+</font></b> e2 <b><font color="#800080">:::</font></b> <font color=Green>TInt</font><font color="#808080">)</font>

  r1 <font color=Green>E</font><font color="#800080">.:==</font> r2 <font color="#808080">-&gt;</font> <u><font color="#804000">do</font></u>
    e1 <b><font color="#800080">:::</font></b> t1    <font color="#808080">&lt;-</font>  infer r1
    e2 <b><font color="#800080">:::</font></b> t2    <font color="#808080">&lt;-</font>  infer r2
    <font color=Green>Refl</font>         <font color="#808080">&lt;-</font>  t1 <font color="#800080">=?=</font> t2
    return <font color="#808080">(</font>e1 <b><font color="#800080">:==</font></b> e2 <b><font color="#800080">:::</font></b> <font color=Green>TBool</font><font color="#808080">)</font>

  <font color=Green>E</font><font color="#800080">.</font><font color=Green>If</font> r1 r2 r3 <font color="#808080">-&gt;</font> <u><font color="#804000">do</font></u>
    e1 <b><font color="#800080">:::</font></b> <font color=Green>TBool</font> <font color="#808080">&lt;-</font>  infer r1
    e2 <b><font color="#800080">:::</font></b> t2    <font color="#808080">&lt;-</font>  infer r2
    e3 <b><font color="#800080">:::</font></b> t3    <font color="#808080">&lt;-</font>  infer r3
    <font color=Green>Refl</font>         <font color="#808080">&lt;-</font>  t2 <font color="#800080">=?=</font> t3
    return <font color="#808080">(</font><font color=Green>If</font> e1 e2 e3 <b><font color="#800080">:::</font></b> t2<font color="#808080">)</font>

<font color=Blue>-- | We can do type checking by inferring a type and comparing</font>
<font color=Blue>-- it to the type we expect.</font>
check <font color="#808080">::</font> <font color=Green>E</font><font color="#800080">.</font><font color=Green>Expr</font> <font color="#808080">-&gt;</font> <font color=Green>Type</font> t <font color="#808080">-&gt;</font> <font color=Green>Maybe</font> <font color="#808080">(</font><font color=Green>Expr</font> t<font color="#808080">)</font>
check r t <font color="#808080">=</font> <u><font color="#804000">do</font></u>
  e <b><font color="#800080">:::</font></b> t' <font color="#808080">&lt;-</font> infer r
  <font color=Green>Refl</font>     <font color="#808080">&lt;-</font> t' <font color="#800080">=?=</font> t
  return e

test1R <font color="#808080">=</font> read <font color=Magenta>"1+2 == 3"</font>
test1  <font color="#808080">=</font> fromJust <font color="#808080">(</font>infer test1R<font color="#808080">)</font>

<font color=Blue>----------------------------------------------------------------</font>
evalTB <font color="#808080">::</font> <font color=Green>E</font><font color="#800080">.</font><font color=Green>Expr</font> <font color="#808080">-&gt;</font> <font color=Green>Maybe</font> <font color=Green>E</font><font color="#800080">.</font><font color=Green>Value</font>
evalTB e <font color="#808080">=</font> <u><font color="#804000">do</font></u>
  b <font color="#808080">&lt;-</font> check e <font color=Green>TBool</font>
  return <font color="#808080">(</font><font color=Green>E</font><font color="#800080">.</font><font color=Green>VBool</font> <font color="#800080">$</font> eval b<font color="#808080">)</font>

evalTI <font color="#808080">::</font> <font color=Green>E</font><font color="#800080">.</font><font color=Green>Expr</font> <font color="#808080">-&gt;</font> <font color=Green>Maybe</font> <font color=Green>E</font><font color="#800080">.</font><font color=Green>Value</font>
evalTI e <font color="#808080">=</font> <u><font color="#804000">do</font></u>
  i <font color="#808080">&lt;-</font> check e <font color=Green>TInt</font>
  return <font color="#808080">(</font><font color=Green>E</font><font color="#800080">.</font><font color=Green>VInt</font> <font color="#800080">$</font> eval i<font color="#808080">)</font>

evalT <font color="#808080">::</font> <font color=Green>E</font><font color="#800080">.</font><font color=Green>Expr</font> <font color="#808080">-&gt;</font> <font color=Green>Maybe</font> <font color=Green>E</font><font color="#800080">.</font><font color=Green>Value</font>
evalT e <font color="#808080">=</font> evalTB e  <font color="#800080">`mplus`</font>  evalTI e

<font color=Blue>--prop_eval :: E.Expr -&gt; Property</font>
prop_eval e <font color="#808080">=</font> <u><font color="#804000">let</font></u>  mv         <font color="#808080">=</font> evalT e
                   wellTyped  <font color="#808080">=</font> isJust   mv
                   v          <font color="#808080">=</font> fromJust mv
              <u><font color="#804000">in</font></u> wellTyped <font color="#800080">==&gt;</font>  
                 label <font color="#808080">(</font><font color=Green>E</font><font color="#800080">.</font>showTypeOfVal v<font color="#808080">)</font> <font color="#800080">$</font>
                 <font color=Green>E</font><font color="#800080">.</font>eval e <font color="#800080">==</font> v

<font color=Blue>-- | Check that the evals agree for well-typed terms</font>
main <font color="#808080">=</font> quickCheck prop_eval
</pre>
</body>
</html>