<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>lectures/lecture14/Memo.hs</title>
</head>
<body>
<pre>
<u><font color="#804000">import</font></u> <font color=Green>Data</font><font color="#800080">.</font><font color=Green>Map</font> <font color="#808080">(</font><font color=Green>Map</font><font color="#808080">)</font>
<u><font color="#804000">import</font></u> <u><font color="#804000">qualified</font></u> <font color=Green>Data</font><font color="#800080">.</font><font color=Green>Map</font> <u><font color="#804000">as</font></u> <font color=Green>Map</font>
<u><font color="#804000">import</font></u> <font color=Green>Data</font><font color="#800080">.</font><font color=Green>List</font>  <font color="#808080">(</font>unfoldr<font color="#808080">)</font>
<u><font color="#804000">import</font></u> <font color=Green>Data</font><font color="#800080">.</font><font color=Green>Maybe</font> <font color="#808080">(</font>fromJust<font color="#808080">)</font>
<u><font color="#804000">import</font></u> <font color=Green>System</font><font color="#800080">.</font><font color=Green>IO</font><font color="#800080">.</font><font color=Green>Unsafe</font> <font color="#808080">(</font>unsafePerformIO<font color="#808080">)</font>
<u><font color="#804000">import</font></u> <font color=Green>Data</font><font color="#800080">.</font><font color=Green>IORef</font> <font color="#808080">(</font>newIORef<font color="#808080">,</font> readIORef<font color="#808080">,</font> writeIORef<font color="#808080">)</font>

<font color=Blue>-- First the non-recursive core of the fibonacci function</font>
fibcore <font color="#808080">::</font> <font color="#808080">(</font><font color=Green>Eq</font> t<font color="#808080">,</font> <font color=Green>Num</font> t<font color="#808080">,</font> <font color=Green>Num</font> a<font color="#808080">)</font> <font color="#808080">=&gt;</font> <font color="#808080">(</font>t <font color="#808080">-&gt;</font> a<font color="#808080">)</font> <font color="#808080">-&gt;</font> t <font color="#808080">-&gt;</font> a
fibcore cont <font color="#808080">=</font> <font color="#808080">\</font>n <font color="#808080">-&gt;</font> <u><font color="#804000">case</font></u> n <u><font color="#804000">of</font></u>
  <font color=Magenta>0</font> <font color="#808080">-&gt;</font> <font color=Magenta>0</font>
  <font color=Magenta>1</font> <font color="#808080">-&gt;</font> <font color=Magenta>1</font>
  n <font color="#808080">-&gt;</font> cont <font color="#808080">(</font>n <font color=Blue>-</font> <font color=Magenta>1</font><font color="#808080">)</font> <font color="#800080">+</font> cont <font color="#808080">(</font>n <font color=Blue>-</font> <font color=Magenta>2</font><font color="#808080">)</font>

<font color=Blue>-- then a pure "memoizer":</font>
memoPure <font color="#808080">::</font> <font color="#808080">(</font><font color=Green>Enum</font> a<font color="#808080">,</font> <font color=Green>Num</font> a<font color="#808080">)</font> <font color="#808080">=&gt;</font> <font color="#808080">(</font>a <font color="#808080">-&gt;</font> b<font color="#808080">)</font> <font color="#808080">-&gt;</font> <font color=Green>Int</font> <font color="#808080">-&gt;</font> b
memoPure f <font color="#808080">=</font> <u><font color="#804000">let</font></u> fs <font color="#808080">=</font> map f <font color="#808080">[</font><font color=Magenta>0</font><font color="#808080">..</font><font color="#808080">]</font>
             <u><font color="#804000">in</font></u> <font color="#808080">(</font>fs<font color="#800080">!!</font><font color="#808080">)</font>

fibPure <font color="#808080">::</font> <font color=Green>Int</font> <font color="#808080">-&gt;</font> <font color=Green>Integer</font>
fibPure <font color="#808080">=</font> memoPure <font color="#800080">$</font> fibcore fibPure

<font color=Blue>-- A completely different "hand-optimized" fib based on </font>
<font color=Blue>--   unfoldr :: (b -&gt; Maybe (a, b)) -&gt; b -&gt; [a] 	</font>
<font color=Blue>-- defined in Data.List</font>
fibUnfoldr <font color="#808080">::</font> <font color="#808080">(</font><font color=Green>Num</font> t<font color="#808080">)</font> <font color="#808080">=&gt;</font> <font color=Green>Int</font> <font color="#808080">-&gt;</font> t
fibUnfoldr <font color="#808080">=</font> 
  <u><font color="#804000">let</font></u> fiblist <font color="#808080">=</font> unfoldr <font color="#808080">(</font><font color="#808080">\</font><font color="#808080">(</font>f1<font color="#808080">,</font>f2<font color="#808080">)</font> <font color="#808080">-&gt;</font> <font color=Green>Just</font> <font color="#808080">(</font>f1<font color="#808080">,</font><font color="#808080">(</font>f2<font color="#808080">,</font>f1<font color="#800080">+</font>f2<font color="#808080">)</font><font color="#808080">)</font><font color="#808080">)</font> <font color="#808080">(</font><font color=Magenta>0</font><font color="#808080">,</font><font color=Magenta>1</font><font color="#808080">)</font>
  <u><font color="#804000">in</font></u> <font color="#808080">(</font>fiblist <font color="#800080">!!</font><font color="#808080">)</font>

<font color=Blue>----------------------------------------------------------------</font>
<font color=Blue>-- Start of impure part</font>
<font color=Blue>-- memo keeps a local cache of all the previous calls</font>
memo <font color="#808080">::</font> <font color=Green>Ord</font> a <font color="#808080">=&gt;</font> <font color="#808080">(</font>a <font color="#808080">-&gt;</font> b<font color="#808080">)</font> <font color="#808080">-&gt;</font> a <font color="#808080">-&gt;</font> b
memo f <font color="#808080">=</font> unsafePerformIO <font color="#800080">$</font> <u><font color="#804000">do</font></u>
  history <font color="#808080">&lt;-</font> newIORef <font color=Green>Map</font><font color="#800080">.</font>empty
  return <font color="#808080">(</font>f' history<font color="#808080">)</font>
  <u><font color="#804000">where</font></u>
    f' history x <font color="#808080">=</font> unsafePerformIO <font color="#800080">$</font> <u><font color="#804000">do</font></u>
      tbl <font color="#808080">&lt;-</font> readIORef history
      <u><font color="#804000">case</font></u> <font color=Green>Map</font><font color="#800080">.</font>lookup x tbl <u><font color="#804000">of</font></u>
        <font color=Green>Just</font> y  <font color="#808080">-&gt;</font> return y
        <font color=Green>Nothing</font> <font color="#808080">-&gt;</font> <u><font color="#804000">do</font></u>
          <u><font color="#804000">let</font></u> y <font color="#808080">=</font> f x
          writeIORef history <font color="#808080">(</font><font color=Green>Map</font><font color="#800080">.</font>insert x y tbl<font color="#808080">)</font>
          return y


<font color=Blue>-- By memoizing the naive implementation of the Fibonacci</font>
<font color=Blue>-- numbers we get an efficient version.</font>
fib <font color="#808080">::</font> <font color=Green>Int</font> <font color="#808080">-&gt;</font> <font color=Green>Integer</font>
fib <font color="#808080">=</font> memo <font color="#800080">$</font> fibcore fib

<font color=Blue>-- You need to be a little careful with sharing to make sure</font>
<font color=Blue>-- that you get a single memo structure and not one for each</font>
<font color=Blue>-- call. For instance, the following doesn't work, since memo</font>
<font color=Blue>-- won't be applied until there is an argument to badfib.</font>
badfib n <font color="#808080">=</font> memo <font color="#808080">(</font>fibcore badfib<font color="#808080">)</font> n

badfib' n <font color="#808080">=</font> memoPure <font color="#808080">(</font>fibcore badfib'<font color="#808080">)</font> n

</pre>
</body>
</html>