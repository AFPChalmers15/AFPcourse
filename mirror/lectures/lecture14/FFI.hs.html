<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>lectures/lecture14/FFI.hs</title>
</head>
<body>
<pre><font color=Blue>{-# LANGUAGE ForeignFunctionInterface #-}</font>
<u><font color="#804000">import</font></u> <font color=Green>Control</font><font color="#800080">.</font><font color=Green>Applicative</font>
<u><font color="#804000">import</font></u> <font color=Green>Foreign</font> <font color="#808080">(</font><font color=Green>Storable</font><font color="#808080">(</font><font color="#808080">..</font><font color="#808080">)</font><font color="#808080">,</font> <font color=Green>Ptr</font><font color="#808080">,</font> alloca<font color="#808080">)</font>
<u><font color="#804000">import</font></u> <font color=Green>Foreign</font><font color="#800080">.</font><font color=Green>C</font> <font color="#808080">(</font><font color=Green>CInt</font><font color="#808080">(</font><font color="#808080">..</font><font color="#808080">)</font><font color="#808080">,</font> <font color=Green>CString</font><font color="#808080">,</font> withCString<font color="#808080">,</font> peekCString<font color="#808080">)</font>
<u><font color="#804000">import</font></u> <font color=Green>System</font><font color="#800080">.</font><font color=Green>IO</font><font color="#800080">.</font><font color=Green>Unsafe</font><font color="#808080">(</font>unsafePerformIO<font color="#808080">)</font>
<u><font color="#804000">import</font></u> <font color=Green>Text</font><font color="#800080">.</font><font color=Green>Printf</font> <font color="#808080">(</font>printf<font color="#808080">)</font>

<font color=Blue>-- For simple types like integers and strings, the Foreign.C</font>
<font color=Blue>-- library contains the C versions of the types and functions</font>
<font color=Blue>-- for converting back and forth.</font>

<font color=Blue>-- We can import foreign functions as pure functions, but we are</font>
<font color=Blue>-- responsible for making sure that they don't have unpleasant</font>
<font color=Blue>-- side effects.</font>
<u><font color="#804000">foreign</font></u> <u><font color="#804000">import</font></u> <u><font color="#804000">ccall</font></u> <font color=Magenta>"inc"</font> c_inc <font color="#808080">::</font> <font color=Green>CInt</font> <font color="#808080">-&gt;</font> <font color=Green>CInt</font>

inc <font color="#808080">::</font> <font color=Green>Int</font> <font color="#808080">-&gt;</font> <font color=Green>Int</font>
inc n <font color="#808080">=</font> fromIntegral <font color="#800080">$</font> c_inc <font color="#808080">(</font>fromIntegral n<font color="#808080">)</font>

<font color=Blue>-- If a function isn't pure, we import it with IO type.</font>
<u><font color="#804000">foreign</font></u> <u><font color="#804000">import</font></u> <u><font color="#804000">ccall</font></u> <font color=Magenta>"encrypt"</font> c_encrypt <font color="#808080">::</font> <font color=Green>CString</font> <font color="#808080">-&gt;</font> <font color=Green>IO</font> <font color=Green>()</font>

<font color=Blue>-- Since the side effects are local (creating a string and doing</font>
<font color=Blue>-- things to it) we can safely pretend that our wrapper is side</font>
<font color=Blue>-- effect free.</font>
encrypt <font color="#808080">::</font> <font color=Green>String</font> <font color="#808080">-&gt;</font> <font color=Green>String</font>
encrypt s <font color="#808080">=</font> unsafePerformIO <font color="#800080">$</font> withCString s <font color="#800080">$</font> <font color="#808080">\</font>cs <font color="#808080">-&gt;</font> <u><font color="#804000">do</font></u>
  c_encrypt cs
  peekCString cs

<font color=Blue>-- For more complex foreign types we give an instance of the</font>
<font color=Blue>-- Storable class to explain how to read and write them from</font>
<font color=Blue>-- memory. In this example the type on the C side is</font>
<font color=Blue>--   struct { int x, y; }</font>

<font color=Blue>-- First declare the corresponding Haskell type.</font>
<u><font color="#804000">data</font></u> <font color=Green>Point</font> <font color="#808080">=</font> <font color=Green>Pt</font> <font color=Green>Int</font> <font color=Green>Int</font>
  <u><font color="#804000">deriving</font></u> <font color=Green>Show</font>

<font color=Blue>-- Import functions to read and write the components.</font>
<u><font color="#804000">foreign</font></u> <u><font color="#804000">import</font></u> <u><font color="#804000">ccall</font></u> <font color=Magenta>"init_pt"</font>   c_init_pt <font color="#808080">::</font> <font color=Green>Ptr</font> <font color=Green>Point</font> <font color="#808080">-&gt;</font> 
                                              <font color=Green>CInt</font> <font color="#808080">-&gt;</font> <font color=Green>CInt</font> <font color="#808080">-&gt;</font> <font color=Green>IO</font> <font color=Green>()</font>
<u><font color="#804000">foreign</font></u> <u><font color="#804000">import</font></u> <u><font color="#804000">ccall</font></u> <font color=Magenta>"get_x"</font>     c_get_x   <font color="#808080">::</font> <font color=Green>Ptr</font> <font color=Green>Point</font> <font color="#808080">-&gt;</font> <font color=Green>IO</font> <font color=Green>CInt</font>
<u><font color="#804000">foreign</font></u> <u><font color="#804000">import</font></u> <u><font color="#804000">ccall</font></u> <font color=Magenta>"get_y"</font>     c_get_y   <font color="#808080">::</font> <font color=Green>Ptr</font> <font color=Green>Point</font> <font color="#808080">-&gt;</font> <font color=Green>IO</font> <font color=Green>CInt</font>
<u><font color="#804000">foreign</font></u> <u><font color="#804000">import</font></u> <u><font color="#804000">ccall</font></u> <font color=Magenta>"sqdist"</font>    c_sqdist  <font color="#808080">::</font> <font color=Green>Ptr</font> <font color=Green>Point</font> <font color="#808080">-&gt;</font> <font color=Green>CInt</font>
<u><font color="#804000">foreign</font></u> <u><font color="#804000">import</font></u> <u><font color="#804000">ccall</font></u> <font color=Magenta>"sizeof_pt"</font> c_sizeof_pt <font color="#808080">::</font> <font color=Green>CInt</font>  
 <font color=Blue>-- still needs to be a function on the C side</font>

<font color=Blue>-- Give the storable instance. For portability we should use</font>
<font color=Blue>-- foreign functions to manipulate the structure.</font>
<u><font color="#804000">instance</font></u> <font color=Green>Storable</font> <font color=Green>Point</font> <u><font color="#804000">where</font></u>
  sizeOf <u><font color="#804000">_</font></u>    <font color="#808080">=</font> fromIntegral c_sizeof_pt
  alignment <u><font color="#804000">_</font></u> <font color="#808080">=</font> <font color=Magenta>4</font>
  peek p <font color="#808080">=</font> <u><font color="#804000">do</font></u>
    x <font color="#808080">&lt;-</font> c_get_x p
    y <font color="#808080">&lt;-</font> c_get_y p
    return <font color="#800080">$</font> <font color=Green>Pt</font> <font color="#808080">(</font>fromIntegral x<font color="#808080">)</font> <font color="#808080">(</font>fromIntegral y<font color="#808080">)</font>
  poke p <font color="#808080">(</font><font color=Green>Pt</font> x y<font color="#808080">)</font> <font color="#808080">=</font> c_init_pt p <font color="#808080">(</font>fromIntegral x<font color="#808080">)</font> <font color="#808080">(</font>fromIntegral y<font color="#808080">)</font>

createPt <font color="#808080">::</font> <font color=Green>Int</font> <font color="#808080">-&gt;</font> <font color=Green>Int</font> <font color="#808080">-&gt;</font> <font color=Green>Point</font>
createPt x y <font color="#808080">=</font> unsafePerformIO <font color="#800080">$</font> alloca <font color="#800080">$</font> <font color="#808080">\</font>p <font color="#808080">-&gt;</font> <u><font color="#804000">do</font></u>
  c_init_pt p <font color="#808080">(</font>fromIntegral x<font color="#808080">)</font> <font color="#808080">(</font>fromIntegral y<font color="#808080">)</font>
  peek p

sqDist <font color="#808080">::</font> <font color=Green>Point</font> <font color="#808080">-&gt;</font> <font color=Green>Int</font>
sqDist pt <font color="#808080">=</font> unsafePerformIO <font color="#800080">$</font> alloca <font color="#800080">$</font> <font color="#808080">\</font>p <font color="#808080">-&gt;</font> <u><font color="#804000">do</font></u>
  poke p pt
  return <font color="#800080">$</font> fromIntegral <font color="#800080">$</font> c_sqdist p

<font color=Blue>----------------</font>
test1 <font color="#808080">::</font> <font color=Green>Int</font>
test1 <font color="#808080">=</font> inc <font color=Magenta>1737</font>
test2 <font color="#808080">::</font> <font color="#808080">(</font><font color=Green>String</font><font color="#808080">,</font> <font color=Green>String</font><font color="#808080">)</font>
test2 <font color="#808080">=</font> <font color="#808080">(</font>encrypted<font color="#808080">,</font> encrypt encrypted<font color="#808080">)</font>
  <u><font color="#804000">where</font></u> encrypted <font color="#808080">=</font> encrypt <font color=Magenta>"Patrik"</font>
test3 <font color="#808080">::</font> <font color=Green>Int</font>
test3 <font color="#808080">=</font> sqDist <font color="#808080">(</font><font color=Green>Pt</font> <font color=Magenta>3</font> <font color=Magenta>4</font><font color="#808080">)</font>

main <font color="#808080">::</font> <font color=Green>IO</font> <font color=Green>()</font>
main <font color="#808080">=</font> <u><font color="#804000">do</font></u> print test1
          uncurry <font color="#808080">(</font>printf <font color=Magenta>"(%s,%s)\n"</font><font color="#808080">)</font> test2
          print test3
</pre>
</body>
</html>