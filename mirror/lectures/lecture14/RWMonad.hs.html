<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>lectures/lecture14/RWMonad.hs</title>
</head>
<body>
<pre><font color=Blue>{-# LANGUAGE GeneralizedNewtypeDeriving #-}</font>
<font color=Blue>{-# LANGUAGE FlexibleInstances #-}</font>

<u><font color="#804000">module</font></u> <font color=Green>RWMonad</font> <u><font color="#804000">where</font></u>
<u><font color="#804000">import</font></u> <font color=Green>Data</font><font color="#800080">.</font><font color=Green>Monoid</font>
<u><font color="#804000">import</font></u> <font color=Green>Test</font><font color="#800080">.</font><font color=Green>QuickCheck</font>
<font color=Blue>-- import qualified Test.QuickCheck.Property as QC</font>
<font color=Blue>-- import qualified Test.QuickCheck.Arbitrary as QC</font>

<font color=Blue>{-

Fake exam question:

A. Implement a "Read-Write" monad |m = RW e w| (for any type |e|
and and monoid |w|) with the following operations:

\begin{code}  
  return :: a -&gt; m a
  (&gt;&gt;=)  :: m a -&gt; (a -&gt; m b) -&gt; m b
  ask    :: m e
  local  :: (e -&gt; e) -&gt; m a -&gt; m a
  tell   :: w -&gt; m ()
  listen :: m a -&gt; m (a, w)
\end{code}

B. State and prove the three Monad laws for |RW e w|.

-}</font>

<u><font color="#804000">instance</font></u> <font color=Green>Monoid</font> w <font color="#808080">=&gt;</font> <font color=Green>Monad</font> <font color="#808080">(</font><font color=Green>RW</font> e w<font color="#808080">)</font> <u><font color="#804000">where</font></u>
  return <font color="#808080">=</font> returnRW
  <font color="#808080">(</font><font color="#800080">&gt;&gt;=</font><font color="#808080">)</font>  <font color="#808080">=</font> bindRW

<u><font color="#804000">newtype</font></u> <font color=Green>RW</font> e w a <font color="#808080">=</font> <font color=Green>RW</font> <font color="#808080">{</font>unRW <font color="#808080">::</font> e <font color="#808080">-&gt;</font> <font color="#808080">(</font>a<font color="#808080">,</font> w<font color="#808080">)</font><font color="#808080">}</font>
  <u><font color="#804000">deriving</font></u> <font color="#808080">(</font><font color=Green>Arbitrary</font><font color="#808080">)</font>
returnRW <font color="#808080">::</font> <font color=Green>Monoid</font> w <font color="#808080">=&gt;</font> a <font color="#808080">-&gt;</font> <font color="#808080">(</font><font color=Green>RW</font> e w<font color="#808080">)</font> a
bindRW   <font color="#808080">::</font> <font color=Green>Monoid</font> w <font color="#808080">=&gt;</font> <font color="#808080">(</font><font color=Green>RW</font> e w<font color="#808080">)</font> a <font color="#808080">-&gt;</font> <font color="#808080">(</font>a <font color="#808080">-&gt;</font> <font color="#808080">(</font><font color=Green>RW</font> e w<font color="#808080">)</font> b<font color="#808080">)</font> <font color="#808080">-&gt;</font> 
                                            <font color="#808080">(</font><font color=Green>RW</font> e w<font color="#808080">)</font> b
askRW    <font color="#808080">::</font> <font color=Green>Monoid</font> w <font color="#808080">=&gt;</font> <font color="#808080">(</font><font color=Green>RW</font> e w<font color="#808080">)</font> e
<font color=Blue>--localRW  :: (e -&gt; e) -&gt; (RW e w) a -&gt; (RW e w) a</font>
tellRW   <font color="#808080">::</font> w <font color="#808080">-&gt;</font> <font color="#808080">(</font><font color=Green>RW</font> e w<font color="#808080">)</font> <font color=Green>()</font>
listenRW <font color="#808080">::</font> <font color="#808080">(</font><font color=Green>RW</font> e w<font color="#808080">)</font> a <font color="#808080">-&gt;</font> <font color="#808080">(</font><font color=Green>RW</font> e w<font color="#808080">)</font> <font color="#808080">(</font>a<font color="#808080">,</font> w<font color="#808080">)</font>

askRW <font color="#808080">=</font> <font color=Green>RW</font> <font color="#808080">(</font><font color="#808080">\</font>e <font color="#808080">-&gt;</font> <font color="#808080">(</font>e<font color="#808080">,</font> mempty<font color="#808080">)</font><font color="#808080">)</font>
localRW e2e <font color="#808080">(</font><font color=Green>RW</font> e2aw<font color="#808080">)</font> <font color="#808080">=</font> <font color=Green>RW</font> <font color="#800080">$</font> <font color="#808080">\</font> e <font color="#808080">-&gt;</font> e2aw <font color="#808080">(</font>e2e e<font color="#808080">)</font> <font color=Blue>-- :: (a, w)</font>
  <font color=Blue>-- e2e :: e -&gt; e</font>
  <font color=Blue>-- e2aw :: e -&gt; (a, w)</font>








returnRW a <font color="#808080">=</font> <font color=Green>RW</font> <font color="#800080">$</font> <font color="#808080">\</font>e<font color="#808080">-&gt;</font> <font color="#808080">(</font>a<font color="#808080">,</font> mempty<font color="#808080">)</font>
bindRW <font color="#808080">(</font><font color=Green>RW</font> e2aw<font color="#808080">)</font> a2m <font color="#808080">=</font> <font color=Green>RW</font> <font color="#800080">$</font> <font color="#808080">\</font>e <font color="#808080">-&gt;</font> <u><font color="#804000">let</font></u> <font color="#808080">(</font>a<font color="#808080">,</font> w1<font color="#808080">)</font> <font color="#808080">=</font> e2aw e
                                      <font color="#808080">(</font>b<font color="#808080">,</font> w2<font color="#808080">)</font> <font color="#808080">=</font> unRW <font color="#808080">(</font>a2m a<font color="#808080">)</font> e
                                  <u><font color="#804000">in</font></u> <font color="#808080">(</font>b<font color="#808080">,</font> w1 <font color="#800080">`mappend`</font> w2<font color="#808080">)</font>
<font color=Blue>-- askRW = RW $ \e -&gt; (e, mempty)</font>
<font color=Blue>-- localRW f (RW e2aw) = RW $ \e -&gt; e2aw (f e)</font>
tellRW w <font color="#808080">=</font> <font color=Green>RW</font> <font color="#800080">$</font> <font color="#808080">\</font>e <font color="#808080">-&gt;</font> <font color="#808080">(</font><font color=Green>()</font><font color="#808080">,</font> w<font color="#808080">)</font>
listenRW <font color="#808080">(</font><font color=Green>RW</font> e2aw<font color="#808080">)</font> <font color="#808080">=</font> <font color=Green>RW</font> <font color="#800080">$</font> <font color="#808080">\</font>e <font color="#808080">-&gt;</font> <u><font color="#804000">let</font></u> <font color="#808080">(</font>a<font color="#808080">,</font> w<font color="#808080">)</font> <font color="#808080">=</font> e2aw e
                                <u><font color="#804000">in</font></u> <font color="#808080">(</font><font color="#808080">(</font>a<font color="#808080">,</font> w<font color="#808080">)</font><font color="#808080">,</font> w<font color="#808080">)</font>

<font color=Blue>-- State and prove the three Monad laws</font>

lawReturnBind <font color="#808080">::</font> <font color="#808080">(</font><font color=Green>Eq</font> <font color="#808080">(</font>m b<font color="#808080">)</font><font color="#808080">,</font> <font color=Green>Monad</font> m<font color="#808080">)</font> <font color="#808080">=&gt;</font> a <font color="#808080">-&gt;</font> <font color="#808080">(</font>a <font color="#808080">-&gt;</font> m b<font color="#808080">)</font> <font color="#808080">-&gt;</font> <font color=Green>Bool</font>
lawReturnBind x f  <font color="#808080">=</font>  <font color="#808080">(</font>return x <font color="#800080">&gt;&gt;=</font> f<font color="#808080">)</font>  <font color="#800080">==</font>  f x

lawBindReturn <font color="#808080">::</font> <font color="#808080">(</font><font color=Green>Eq</font> <font color="#808080">(</font>m b<font color="#808080">)</font><font color="#808080">,</font> <font color=Green>Monad</font> m<font color="#808080">)</font> <font color="#808080">=&gt;</font> m b <font color="#808080">-&gt;</font> <font color=Green>Bool</font>
lawBindReturn m    <font color="#808080">=</font>  <font color="#808080">(</font>m <font color="#800080">&gt;&gt;=</font> return<font color="#808080">)</font>    <font color="#800080">==</font>  m

lawBindBind <font color="#808080">::</font>
  <font color="#808080">(</font><font color=Green>Eq</font> <font color="#808080">(</font>m c<font color="#808080">)</font><font color="#808080">,</font> <font color=Green>Monad</font> m<font color="#808080">)</font> <font color="#808080">=&gt;</font> m a <font color="#808080">-&gt;</font> <font color="#808080">(</font>a <font color="#808080">-&gt;</font> m b<font color="#808080">)</font> <font color="#808080">-&gt;</font> <font color="#808080">(</font>b <font color="#808080">-&gt;</font> m c<font color="#808080">)</font> <font color="#808080">-&gt;</font> <font color=Green>Bool</font>
lawBindBind m f g  <font color="#808080">=</font> <font color="#808080">(</font><font color="#808080">(</font>m <font color="#800080">&gt;&gt;=</font> f<font color="#808080">)</font> <font color="#800080">&gt;&gt;=</font> g<font color="#808080">)</font> <font color="#800080">==</font>  <font color="#808080">(</font>m <font color="#800080">&gt;&gt;=</font> <font color="#808080">(</font><font color="#808080">\</font>x<font color="#808080">-&gt;</font> f x <font color="#800080">&gt;&gt;=</font> g<font color="#808080">)</font><font color="#808080">)</font>

<font color=Blue>-- Straw-man proofs in Haskell (just a list of supposedly equal</font>
<font color=Blue>-- expr.)</font>
<u><font color="#804000">newtype</font></u> <font color=Green>AllEq</font> a <font color="#808080">=</font> <font color=Green>AllEq</font> <font color="#808080">[</font>a<font color="#808080">]</font> 
  <u><font color="#804000">deriving</font></u> <font color="#808080">(</font><font color=Green>Arbitrary</font><font color="#808080">)</font>

proofReturnBind <font color="#808080">::</font> <font color="#808080">(</font><font color=Green>Monoid</font> w<font color="#808080">)</font> <font color="#808080">=&gt;</font> a <font color="#808080">-&gt;</font> <font color="#808080">(</font>a <font color="#808080">-&gt;</font> <font color=Green>RW</font> e w b<font color="#808080">)</font> <font color="#808080">-&gt;</font> 
                   <font color=Green>AllEq</font> <font color="#808080">(</font><font color=Green>RW</font> e w b<font color="#808080">)</font>
proofReturnBind x f <font color="#808080">=</font> <font color=Green>AllEq</font> 
  <font color="#808080">[</font>
    <font color="#808080">(</font>return x <font color="#800080">&gt;&gt;=</font> f<font color="#808080">)</font>
  <font color="#808080">,</font> <font color=Blue>-- Monad instance for RW</font>
    <font color="#808080">(</font>returnRW x <font color="#800080">`bindRW`</font> f<font color="#808080">)</font>
  <font color="#808080">,</font> <font color=Blue>{- def. returnRW -}</font>
    <font color="#808080">(</font><font color="#808080">(</font><font color=Green>RW</font> <font color="#800080">$</font> <font color="#808080">\</font>e<font color="#808080">-&gt;</font><font color="#808080">(</font>x<font color="#808080">,</font> mempty<font color="#808080">)</font><font color="#808080">)</font> <font color="#800080">`bindRW`</font> f<font color="#808080">)</font>
  <font color="#808080">,</font> <font color=Blue>{- def. bindRW -}</font>
    <u><font color="#804000">let</font></u> e2aw <font color="#808080">=</font> <font color="#808080">\</font>e<font color="#808080">-&gt;</font><font color="#808080">(</font>x<font color="#808080">,</font> mempty<font color="#808080">)</font> 
        a2m <font color="#808080">=</font> f
    <u><font color="#804000">in</font></u> <font color=Green>RW</font> <font color="#800080">$</font> <font color="#808080">\</font>e <font color="#808080">-&gt;</font> <u><font color="#804000">let</font></u> <font color="#808080">(</font>a<font color="#808080">,</font> w1<font color="#808080">)</font> <font color="#808080">=</font> e2aw e
                      <font color="#808080">(</font>b<font color="#808080">,</font> w2<font color="#808080">)</font> <font color="#808080">=</font> unRW <font color="#808080">(</font>a2m a<font color="#808080">)</font> e
                  <u><font color="#804000">in</font></u> <font color="#808080">(</font>b<font color="#808080">,</font> w1 <font color="#800080">`mappend`</font> w2<font color="#808080">)</font>
  <font color="#808080">,</font> <font color=Blue>{- inlining -}</font>
    <font color=Green>RW</font> <font color="#800080">$</font> <font color="#808080">\</font>e <font color="#808080">-&gt;</font> <u><font color="#804000">let</font></u> <font color="#808080">(</font>a<font color="#808080">,</font> w1<font color="#808080">)</font> <font color="#808080">=</font> <font color="#808080">(</font><font color="#808080">\</font>e<font color="#808080">-&gt;</font><font color="#808080">(</font>x<font color="#808080">,</font> mempty<font color="#808080">)</font><font color="#808080">)</font> e
                   <font color="#808080">(</font>b<font color="#808080">,</font> w2<font color="#808080">)</font> <font color="#808080">=</font> unRW <font color="#808080">(</font>f a<font color="#808080">)</font> e
               <u><font color="#804000">in</font></u> <font color="#808080">(</font>b<font color="#808080">,</font> w1 <font color="#800080">`mappend`</font> w2<font color="#808080">)</font>
  <font color="#808080">,</font> <font color=Blue>{- beta-red.  -}</font>
    <font color=Green>RW</font> <font color="#800080">$</font> <font color="#808080">\</font>e <font color="#808080">-&gt;</font> <u><font color="#804000">let</font></u> <font color="#808080">(</font>a<font color="#808080">,</font> w1<font color="#808080">)</font> <font color="#808080">=</font> <font color="#808080">(</font>x<font color="#808080">,</font> mempty<font color="#808080">)</font>
                   <font color="#808080">(</font>b<font color="#808080">,</font> w2<font color="#808080">)</font> <font color="#808080">=</font> unRW <font color="#808080">(</font>f a<font color="#808080">)</font> e
               <u><font color="#804000">in</font></u> <font color="#808080">(</font>b<font color="#808080">,</font> w1 <font color="#800080">`mappend`</font> w2<font color="#808080">)</font>
  <font color="#808080">,</font> <font color=Blue>{- inlining a, w1 -}</font>
    <font color=Green>RW</font> <font color="#800080">$</font> <font color="#808080">\</font>e <font color="#808080">-&gt;</font> <u><font color="#804000">let</font></u> <font color="#808080">(</font>b<font color="#808080">,</font> w2<font color="#808080">)</font> <font color="#808080">=</font> unRW <font color="#808080">(</font>f x<font color="#808080">)</font> e
               <u><font color="#804000">in</font></u> <font color="#808080">(</font>b<font color="#808080">,</font> mempty <font color="#800080">`mappend`</font> w2<font color="#808080">)</font>
  <font color="#808080">,</font> <font color=Blue>{- Monoid law -}</font>
    <font color=Green>RW</font> <font color="#800080">$</font> <font color="#808080">\</font>e <font color="#808080">-&gt;</font> <u><font color="#804000">let</font></u> <font color="#808080">(</font>b<font color="#808080">,</font> w2<font color="#808080">)</font> <font color="#808080">=</font> unRW <font color="#808080">(</font>f x<font color="#808080">)</font> e
               <u><font color="#804000">in</font></u> <font color="#808080">(</font>b<font color="#808080">,</font> w2<font color="#808080">)</font>
  <font color="#808080">,</font> <font color=Blue>{- inlining -}</font>
    <font color=Green>RW</font> <font color="#800080">$</font> <font color="#808080">\</font>e <font color="#808080">-&gt;</font> unRW <font color="#808080">(</font>f x<font color="#808080">)</font> e
  <font color="#808080">,</font> <font color=Blue>{- eta-reduction -}</font>
    <font color=Green>RW</font> <font color="#800080">$</font> unRW <font color="#808080">(</font>f x<font color="#808080">)</font>
  <font color="#808080">,</font> <font color=Blue>{- RW . unRW == id -}</font>
    f x
  <font color="#808080">]</font>

proofBindReturn m <font color="#808080">=</font> <font color=Green>AllEq</font>
  <font color="#808080">[</font>
    m <font color="#800080">&gt;&gt;=</font> return 
  <font color="#808080">,</font> <font color=Blue>{- type instance -}</font>
    m <font color="#800080">`bindRW`</font> returnRW
  <font color="#808080">,</font> <font color=Blue>{- def. of bindRW -}</font>
    <u><font color="#804000">let</font></u> e2aw <font color="#808080">=</font> unRW m
        a2m  <font color="#808080">=</font> returnRW
    <u><font color="#804000">in</font></u> <font color=Green>RW</font> <font color="#800080">$</font> <font color="#808080">\</font>e <font color="#808080">-&gt;</font> <u><font color="#804000">let</font></u> <font color="#808080">(</font>a<font color="#808080">,</font> w1<font color="#808080">)</font> <font color="#808080">=</font> e2aw e
                      <font color="#808080">(</font>b<font color="#808080">,</font> w2<font color="#808080">)</font> <font color="#808080">=</font> unRW <font color="#808080">(</font>a2m a<font color="#808080">)</font> e
                  <u><font color="#804000">in</font></u> <font color="#808080">(</font>b<font color="#808080">,</font> w1 <font color="#800080">`mappend`</font> w2<font color="#808080">)</font>
  <font color="#808080">,</font> <font color=Blue>{- inlining -}</font>
    <font color=Green>RW</font> <font color="#800080">$</font> <font color="#808080">\</font>e <font color="#808080">-&gt;</font> <u><font color="#804000">let</font></u> <font color="#808080">(</font>a<font color="#808080">,</font> w1<font color="#808080">)</font> <font color="#808080">=</font> unRW m e
                   <font color="#808080">(</font>b<font color="#808080">,</font> w2<font color="#808080">)</font> <font color="#808080">=</font> unRW <font color="#808080">(</font>returnRW a<font color="#808080">)</font> e
               <u><font color="#804000">in</font></u> <font color="#808080">(</font>b<font color="#808080">,</font> w1 <font color="#800080">`mappend`</font> w2<font color="#808080">)</font>
  <font color="#808080">,</font> <font color=Blue>{- def. returnRW -}</font>
    <font color=Green>RW</font> <font color="#800080">$</font> <font color="#808080">\</font>e <font color="#808080">-&gt;</font> <u><font color="#804000">let</font></u> <font color="#808080">(</font>a<font color="#808080">,</font> w1<font color="#808080">)</font> <font color="#808080">=</font> unRW m e
                   <font color="#808080">(</font>b<font color="#808080">,</font> w2<font color="#808080">)</font> <font color="#808080">=</font> unRW <font color="#808080">(</font><font color=Green>RW</font> <font color="#800080">$</font> <font color="#808080">\</font>e<font color="#808080">-&gt;</font><font color="#808080">(</font>a<font color="#808080">,</font> mempty<font color="#808080">)</font><font color="#808080">)</font> e
               <u><font color="#804000">in</font></u> <font color="#808080">(</font>b<font color="#808080">,</font> w1 <font color="#800080">`mappend`</font> w2<font color="#808080">)</font>
  <font color="#808080">,</font> <font color=Blue>{- unRW . RW == id, beta-red. -}</font>
    <font color=Green>RW</font> <font color="#800080">$</font> <font color="#808080">\</font>e <font color="#808080">-&gt;</font> <u><font color="#804000">let</font></u> <font color="#808080">(</font>a<font color="#808080">,</font> w1<font color="#808080">)</font> <font color="#808080">=</font> unRW m e
                   <font color="#808080">(</font>b<font color="#808080">,</font> w2<font color="#808080">)</font> <font color="#808080">=</font> <font color="#808080">(</font>a<font color="#808080">,</font> mempty<font color="#808080">)</font>
               <u><font color="#804000">in</font></u> <font color="#808080">(</font>b<font color="#808080">,</font> w1 <font color="#800080">`mappend`</font> w2<font color="#808080">)</font>
  <font color="#808080">,</font> <font color=Blue>{- inlining -}</font>
    <font color=Green>RW</font> <font color="#800080">$</font> <font color="#808080">\</font>e <font color="#808080">-&gt;</font> <u><font color="#804000">let</font></u> <font color="#808080">(</font>a<font color="#808080">,</font> w1<font color="#808080">)</font> <font color="#808080">=</font> unRW m e
               <u><font color="#804000">in</font></u> <font color="#808080">(</font>a<font color="#808080">,</font> w1 <font color="#800080">`mappend`</font> mempty<font color="#808080">)</font>
  <font color="#808080">,</font> <font color=Blue>{- Monoid law -}</font>
    <font color=Green>RW</font> <font color="#800080">$</font> <font color="#808080">\</font>e <font color="#808080">-&gt;</font> <u><font color="#804000">let</font></u> <font color="#808080">(</font>a<font color="#808080">,</font> w1<font color="#808080">)</font> <font color="#808080">=</font> unRW m e
               <u><font color="#804000">in</font></u> <font color="#808080">(</font>a<font color="#808080">,</font> w1<font color="#808080">)</font>
  <font color="#808080">,</font> <font color=Blue>{- inlining -}</font>
    <font color=Green>RW</font> <font color="#800080">$</font> <font color="#808080">\</font>e <font color="#808080">-&gt;</font> unRW m e
  <font color="#808080">,</font> <font color=Blue>{- eta-contraction, unRW . RW == id -}</font>
    m
  <font color="#808080">]</font>



proofBindBind m f g  <font color="#808080">=</font> <font color=Green>AllEq</font>
  <font color="#808080">[</font>
    <font color="#808080">(</font>m <font color="#800080">&gt;&gt;=</font> f<font color="#808080">)</font> <font color="#800080">&gt;&gt;=</font> g
  <font color="#808080">,</font> <font color=Blue>{- Monad instance-}</font>  
    <font color="#808080">(</font>m <font color="#800080">`bindRW`</font> f<font color="#808080">)</font> <font color="#800080">`bindRW`</font> g
  <font color="#808080">,</font> <font color=Blue>-- def. bindRW</font>
    <u><font color="#804000">let</font></u> e2aw <font color="#808080">=</font> unRW <font color="#808080">(</font>m <font color="#800080">`bindRW`</font> f<font color="#808080">)</font>
        a2m  <font color="#808080">=</font> g
    <u><font color="#804000">in</font></u> <font color=Green>RW</font> <font color="#800080">$</font> <font color="#808080">\</font>e <font color="#808080">-&gt;</font> <u><font color="#804000">let</font></u> <font color="#808080">(</font>a<font color="#808080">,</font> w1<font color="#808080">)</font> <font color="#808080">=</font> e2aw e
                      <font color="#808080">(</font>b<font color="#808080">,</font> w2<font color="#808080">)</font> <font color="#808080">=</font> unRW <font color="#808080">(</font>a2m a<font color="#808080">)</font> e
                  <u><font color="#804000">in</font></u> <font color="#808080">(</font>b<font color="#808080">,</font> w1 <font color="#800080">`mappend`</font> w2<font color="#808080">)</font>
  <font color="#808080">,</font> <font color=Blue>-- inlining</font>
    <font color=Green>RW</font> <font color="#800080">$</font> <font color="#808080">\</font>e <font color="#808080">-&gt;</font> <u><font color="#804000">let</font></u> <font color="#808080">(</font>a<font color="#808080">,</font> w1<font color="#808080">)</font> <font color="#808080">=</font> unRW <font color="#808080">(</font>m <font color="#800080">`bindRW`</font> f<font color="#808080">)</font> e
                   <font color="#808080">(</font>b<font color="#808080">,</font> w2<font color="#808080">)</font> <font color="#808080">=</font> unRW <font color="#808080">(</font>g a<font color="#808080">)</font> e
               <u><font color="#804000">in</font></u> <font color="#808080">(</font>b<font color="#808080">,</font> w1 <font color="#800080">`mappend`</font> w2<font color="#808080">)</font>
  <font color="#808080">,</font> <font color=Blue>-- def. bindRW (again) + inline + prime, unRW . RW == id, beta</font>
    <font color=Green>RW</font> <font color="#800080">$</font> <font color="#808080">\</font>e <font color="#808080">-&gt;</font> <u><font color="#804000">let</font></u> <font color="#808080">(</font>a<font color="#808080">,</font> w1<font color="#808080">)</font> <font color="#808080">=</font> <u><font color="#804000">let</font></u> <font color="#808080">(</font>a'<font color="#808080">,</font> w1'<font color="#808080">)</font> <font color="#808080">=</font> unRW m e
                                 <font color="#808080">(</font>b'<font color="#808080">,</font> w2'<font color="#808080">)</font> <font color="#808080">=</font> unRW <font color="#808080">(</font>f a'<font color="#808080">)</font> e
                             <u><font color="#804000">in</font></u> <font color="#808080">(</font>b'<font color="#808080">,</font> w1' <font color="#800080">`mappend`</font> w2'<font color="#808080">)</font>
                   <font color="#808080">(</font>b<font color="#808080">,</font> w2<font color="#808080">)</font> <font color="#808080">=</font> unRW <font color="#808080">(</font>g a<font color="#808080">)</font> e
               <u><font color="#804000">in</font></u> <font color="#808080">(</font>b<font color="#808080">,</font> w1 <font color="#800080">`mappend`</font> w2<font color="#808080">)</font>

  <font color="#808080">,</font> <font color=Blue>-- let-float</font>
    <font color=Green>RW</font> <font color="#800080">$</font> <font color="#808080">\</font>e <font color="#808080">-&gt;</font> <u><font color="#804000">let</font></u> <font color="#808080">(</font>a'<font color="#808080">,</font> w1'<font color="#808080">)</font> <font color="#808080">=</font> unRW m e     
                   <font color="#808080">(</font>b'<font color="#808080">,</font> w2'<font color="#808080">)</font> <font color="#808080">=</font> unRW <font color="#808080">(</font>f a'<font color="#808080">)</font> e
                   <font color="#808080">(</font>a<font color="#808080">,</font> w1<font color="#808080">)</font> <font color="#808080">=</font> <font color="#808080">(</font>b'<font color="#808080">,</font> w1' <font color="#800080">`mappend`</font> w2'<font color="#808080">)</font>
                   <font color="#808080">(</font>b<font color="#808080">,</font> w2<font color="#808080">)</font> <font color="#808080">=</font> unRW <font color="#808080">(</font>g a<font color="#808080">)</font> e
               <u><font color="#804000">in</font></u> <font color="#808080">(</font>b<font color="#808080">,</font> w1 <font color="#800080">`mappend`</font> w2<font color="#808080">)</font>
  <font color="#808080">,</font> <font color=Blue>-- substitute</font>
    <font color=Green>RW</font> <font color="#800080">$</font> <font color="#808080">\</font>e <font color="#808080">-&gt;</font> <u><font color="#804000">let</font></u> <font color="#808080">(</font>a'<font color="#808080">,</font> w1'<font color="#808080">)</font> <font color="#808080">=</font> unRW m e     
                   <font color="#808080">(</font>b'<font color="#808080">,</font> w2'<font color="#808080">)</font> <font color="#808080">=</font> unRW <font color="#808080">(</font>f a'<font color="#808080">)</font> e
                   <font color="#808080">(</font>b<font color="#808080">,</font> w2<font color="#808080">)</font>   <font color="#808080">=</font> unRW <font color="#808080">(</font>g b'<font color="#808080">)</font> e
               <u><font color="#804000">in</font></u> <font color="#808080">(</font>b<font color="#808080">,</font> <font color="#808080">(</font>w1' <font color="#800080">`mappend`</font> w2'<font color="#808080">)</font> <font color="#800080">`mappend`</font> w2<font color="#808080">)</font>

  <font color="#808080">,</font>  <font color=Blue>-- rename + Monoid append associativity</font>
    <font color=Green>RW</font> <font color="#800080">$</font> <font color="#808080">\</font>e <font color="#808080">-&gt;</font> <u><font color="#804000">let</font></u> <font color="#808080">(</font>a<font color="#808080">,</font> w1<font color="#808080">)</font>   <font color="#808080">=</font> unRW m e     
                   <font color="#808080">(</font>b<font color="#808080">,</font> w2<font color="#808080">)</font>   <font color="#808080">=</font> unRW <font color="#808080">(</font>f a<font color="#808080">)</font> e
                   <font color="#808080">(</font>c<font color="#808080">,</font> w3<font color="#808080">)</font>   <font color="#808080">=</font> unRW <font color="#808080">(</font>g b<font color="#808080">)</font> e
               <u><font color="#804000">in</font></u> <font color="#808080">(</font>c<font color="#808080">,</font> w1 <font color="#800080">`mappend`</font> <font color="#808080">(</font>w2 <font color="#800080">`mappend`</font> w3<font color="#808080">)</font><font color="#808080">)</font>
  <font color="#808080">,</font>
    <font color=Green>RW</font> <font color="#800080">$</font> <font color="#808080">\</font>e <font color="#808080">-&gt;</font> <u><font color="#804000">let</font></u> <font color="#808080">(</font>a<font color="#808080">,</font> w1<font color="#808080">)</font>   <font color="#808080">=</font> unRW m e
                   <font color="#808080">(</font>a'<font color="#808080">,</font> w1'<font color="#808080">)</font> <font color="#808080">=</font> unRW <font color="#808080">(</font>f a<font color="#808080">)</font> e
                   <font color="#808080">(</font>b'<font color="#808080">,</font> w2'<font color="#808080">)</font> <font color="#808080">=</font> unRW <font color="#808080">(</font>g a'<font color="#808080">)</font> e
               <u><font color="#804000">in</font></u> <font color="#808080">(</font>b'<font color="#808080">,</font> w1 <font color="#800080">`mappend`</font> <font color="#808080">(</font>w1' <font color="#800080">`mappend`</font> w2'<font color="#808080">)</font><font color="#808080">)</font>
  <font color="#808080">,</font>  <font color=Blue>-- substitute</font>
    <font color=Green>RW</font> <font color="#800080">$</font> <font color="#808080">\</font>e <font color="#808080">-&gt;</font> <u><font color="#804000">let</font></u> <font color="#808080">(</font>a<font color="#808080">,</font> w1<font color="#808080">)</font> <font color="#808080">=</font> unRW m e
                   <font color="#808080">(</font>b<font color="#808080">,</font> w2<font color="#808080">)</font> <font color="#808080">=</font> <u><font color="#804000">let</font></u> <font color="#808080">(</font>a'<font color="#808080">,</font> w1'<font color="#808080">)</font> <font color="#808080">=</font> unRW <font color="#808080">(</font>f a<font color="#808080">)</font> e
                                 <font color="#808080">(</font>b'<font color="#808080">,</font> w2'<font color="#808080">)</font> <font color="#808080">=</font> unRW <font color="#808080">(</font>g a'<font color="#808080">)</font> e
                             <u><font color="#804000">in</font></u> <font color="#808080">(</font>b'<font color="#808080">,</font> w1' <font color="#800080">`mappend`</font> w2'<font color="#808080">)</font>
               <u><font color="#804000">in</font></u> <font color="#808080">(</font>b<font color="#808080">,</font> w1 <font color="#800080">`mappend`</font> w2<font color="#808080">)</font>
  <font color="#808080">,</font>  <font color=Blue>-- inline (+add primes), unRW . RW == id, beta red.</font>
    <font color=Green>RW</font> <font color="#800080">$</font> <font color="#808080">\</font>e <font color="#808080">-&gt;</font> <u><font color="#804000">let</font></u> <font color="#808080">(</font>a<font color="#808080">,</font> w1<font color="#808080">)</font> <font color="#808080">=</font> unRW m e
                   <font color="#808080">(</font>b<font color="#808080">,</font> w2<font color="#808080">)</font> <font color="#808080">=</font> unRW <font color="#808080">(</font>
                     <u><font color="#804000">let</font></u> e2aw <font color="#808080">=</font> unRW <font color="#808080">(</font>f a<font color="#808080">)</font>
                         a2m  <font color="#808080">=</font> g
                     <u><font color="#804000">in</font></u> <font color=Green>RW</font> <font color="#800080">$</font> <font color="#808080">\</font>e <font color="#808080">-&gt;</font> <u><font color="#804000">let</font></u> <font color="#808080">(</font>a<font color="#808080">,</font> w1<font color="#808080">)</font> <font color="#808080">=</font> e2aw e
                                       <font color="#808080">(</font>b<font color="#808080">,</font> w2<font color="#808080">)</font> <font color="#808080">=</font> unRW <font color="#808080">(</font>a2m a<font color="#808080">)</font> e
                                   <u><font color="#804000">in</font></u> <font color="#808080">(</font>b<font color="#808080">,</font> w1 <font color="#800080">`mappend`</font> w2<font color="#808080">)</font>
                     <font color="#808080">)</font> e
               <u><font color="#804000">in</font></u> <font color="#808080">(</font>b<font color="#808080">,</font> w1 <font color="#800080">`mappend`</font> w2<font color="#808080">)</font>
  <font color="#808080">,</font>  <font color=Blue>-- def. of bindRW (again)</font>
    <font color=Green>RW</font> <font color="#800080">$</font> <font color="#808080">\</font>e <font color="#808080">-&gt;</font> <u><font color="#804000">let</font></u> <font color="#808080">(</font>a<font color="#808080">,</font> w1<font color="#808080">)</font> <font color="#808080">=</font> unRW m e
                   <font color="#808080">(</font>b<font color="#808080">,</font> w2<font color="#808080">)</font> <font color="#808080">=</font> unRW <font color="#808080">(</font>f a <font color="#800080">`bindRW`</font> g<font color="#808080">)</font> e
               <u><font color="#804000">in</font></u> <font color="#808080">(</font>b<font color="#808080">,</font> w1 <font color="#800080">`mappend`</font> w2<font color="#808080">)</font>
  <font color="#808080">,</font>  <font color=Blue>-- beta-red.</font>
    <font color=Green>RW</font> <font color="#800080">$</font> <font color="#808080">\</font>e <font color="#808080">-&gt;</font> <u><font color="#804000">let</font></u> <font color="#808080">(</font>a<font color="#808080">,</font> w1<font color="#808080">)</font> <font color="#808080">=</font> unRW m e
                   <font color="#808080">(</font>b<font color="#808080">,</font> w2<font color="#808080">)</font> <font color="#808080">=</font> unRW <font color="#808080">(</font><font color="#808080">(</font><font color="#808080">\</font>x<font color="#808080">-&gt;</font> f x <font color="#800080">`bindRW`</font> g<font color="#808080">)</font> a<font color="#808080">)</font> e
               <u><font color="#804000">in</font></u> <font color="#808080">(</font>b<font color="#808080">,</font> w1 <font color="#800080">`mappend`</font> w2<font color="#808080">)</font>
  <font color="#808080">,</font>  <font color=Blue>-- inlining</font>
    <u><font color="#804000">let</font></u> e2aw <font color="#808080">=</font> unRW m
        a2m  <font color="#808080">=</font> <font color="#808080">(</font><font color="#808080">\</font>x<font color="#808080">-&gt;</font> f x <font color="#800080">`bindRW`</font> g<font color="#808080">)</font>
    <u><font color="#804000">in</font></u> <font color=Green>RW</font> <font color="#800080">$</font> <font color="#808080">\</font>e <font color="#808080">-&gt;</font> <u><font color="#804000">let</font></u> <font color="#808080">(</font>a<font color="#808080">,</font> w1<font color="#808080">)</font> <font color="#808080">=</font> e2aw e
                      <font color="#808080">(</font>b<font color="#808080">,</font> w2<font color="#808080">)</font> <font color="#808080">=</font> unRW <font color="#808080">(</font>a2m a<font color="#808080">)</font> e
                  <u><font color="#804000">in</font></u> <font color="#808080">(</font>b<font color="#808080">,</font> w1 <font color="#800080">`mappend`</font> w2<font color="#808080">)</font>
  <font color="#808080">,</font> <font color=Blue>-- def. bindRW</font>
    <font color="#808080">(</font>m <font color="#800080">`bindRW`</font> <font color="#808080">(</font><font color="#808080">\</font>x<font color="#808080">-&gt;</font> f x <font color="#800080">`bindRW`</font> g<font color="#808080">)</font><font color="#808080">)</font>
  <font color="#808080">,</font> <font color=Blue>{- Monad instance-}</font>  
    <font color="#808080">(</font>m <font color="#800080">&gt;&gt;=</font> <font color="#808080">(</font><font color="#808080">\</font>x<font color="#808080">-&gt;</font> f x <font color="#800080">&gt;&gt;=</font> g<font color="#808080">)</font><font color="#808080">)</font>
  <font color="#808080">]</font>

mytest <font color="#808080">(</font><font color=Green>AllEq</font> ms<font color="#808080">)</font> <font color="#808080">=</font> forAll arbitrary <font color="#800080">$</font> <font color="#808080">\</font>e <font color="#808080">-&gt;</font> 
                    allEq <font color="#800080">$</font> map <font color="#808080">(</font>flip unRW e<font color="#808080">)</font> ms

allEq <font color=Green>[]</font>      <font color="#808080">=</font>  <font color=Green>True</font>
allEq <font color="#808080">(</font>x<b><font color="#800080">:</font></b>xs<font color="#808080">)</font>  <font color="#808080">=</font>  all <font color="#808080">(</font>x<font color="#800080">==</font><font color="#808080">)</font> xs

<u><font color="#804000">instance</font></u> <font color="#808080">(</font><font color=Green>Eq</font> a<font color="#808080">,</font> <font color=Green>Eq</font> w<font color="#808080">,</font> <font color=Green>Show</font> b<font color="#808080">,</font> <font color=Green>Arbitrary</font> b<font color="#808080">)</font> <font color="#808080">=&gt;</font> 
         <font color=Green>Testable</font> <font color="#808080">(</font><font color=Green>AllEq</font> <font color="#808080">(</font><font color=Green>RW</font> b w a<font color="#808080">)</font><font color="#808080">)</font> <u><font color="#804000">where</font></u> 
  property <font color="#808080">=</font> mytest

proofReturnBind' <font color="#808080">::</font> <font color=Green>Bool</font> <font color="#808080">-&gt;</font> <font color=Green>Blind</font> <font color="#808080">(</font><font color=Green>Bool</font> <font color="#808080">-&gt;</font> <font color=Green>RW</font> <font color=Green>Int</font> <font color=Green>String</font> <font color=Green>Char</font><font color="#808080">)</font> <font color="#808080">-&gt;</font> 
                    <font color=Green>AllEq</font> <font color="#808080">(</font><font color=Green>RW</font> <font color=Green>Int</font> <font color=Green>String</font> <font color=Green>Char</font><font color="#808080">)</font>
proofReturnBind' x <font color="#808080">(</font><font color=Green>Blind</font> f<font color="#808080">)</font> <font color="#808080">=</font> proofReturnBind x f

proofBindReturn' <font color="#808080">::</font> <font color=Green>Blind</font> <font color="#808080">(</font><font color=Green>RW</font> <font color=Green>Int</font> <font color=Green>String</font> <font color=Green>Char</font><font color="#808080">)</font> <font color="#808080">-&gt;</font> 
                    <font color=Green>AllEq</font> <font color="#808080">(</font><font color=Green>RW</font> <font color=Green>Int</font> <font color=Green>String</font> <font color=Green>Char</font><font color="#808080">)</font>
proofBindReturn' <font color="#808080">(</font><font color=Green>Blind</font> m<font color="#808080">)</font> <font color="#808080">=</font> proofBindReturn m

<u><font color="#804000">type</font></u> <font color=Green>RWIS</font> <font color="#808080">=</font> <font color=Green>RW</font> <font color=Green>Int</font> <font color=Green>String</font>

proofBindBind' <font color="#808080">::</font> <font color=Green>Blind</font> <font color="#808080">(</font><font color=Green>RWIS</font> <font color=Green>Bool</font><font color="#808080">)</font> <font color="#808080">-&gt;</font> 
                  <font color=Green>Blind</font> <font color="#808080">(</font><font color=Green>Bool</font> <font color="#808080">-&gt;</font> <font color=Green>RWIS</font> <font color=Green>Char</font><font color="#808080">)</font> <font color="#808080">-&gt;</font> 
                  <font color=Green>Blind</font> <font color="#808080">(</font><font color=Green>Char</font> <font color="#808080">-&gt;</font> <font color=Green>RWIS</font> <font color=Green>Int</font><font color="#808080">)</font> <font color="#808080">-&gt;</font> 
                  <font color=Green>AllEq</font> <font color="#808080">(</font><font color=Green>RWIS</font> <font color=Green>Int</font><font color="#808080">)</font>
proofBindBind' <font color="#808080">(</font><font color=Green>Blind</font> m<font color="#808080">)</font> <font color="#808080">(</font><font color=Green>Blind</font> f<font color="#808080">)</font> <font color="#808080">(</font><font color=Green>Blind</font> g<font color="#808080">)</font> <font color="#808080">=</font> proofBindBind m f g
  
main <font color="#808080">=</font> <u><font color="#804000">do</font></u> 
  quickCheck proofBindBind'
  quickCheck proofBindReturn'
  quickCheck proofReturnBind'


<font color=Blue>-- ----------------------------------------------------------------</font>
<font color=Blue>{-
instance Eq a =&gt; Testable (AllEq a) where
  property = propertyAllEq 
                          
propertyAllEq :: Eq a =&gt; AllEq a -&gt; Property
propertyAllEq (AllEq xs) = QC.property $ QC.liftBool $ allEq xs
-}</font>

<font color=Blue>{-
instance (Arbitrary e, Show e, Testable prop) =&gt; 
         Testable (RW e w a) where
  property f = forAllShrink arbitrary shrink f
-}</font>



</pre>
</body>
</html>