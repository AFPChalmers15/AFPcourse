<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>lectures/lecture14/Cont.hs</title>
</head>
<body>
<pre><font color=Blue>{-# LANGUAGE GeneralizedNewtypeDeriving #-}</font>
<font color=Blue>-- RankNTypes, </font>
<u><font color="#804000">import</font></u> <font color=Green>Control</font><font color="#800080">.</font><font color=Green>Monad</font>
<u><font color="#804000">import</font></u> <font color=Green>Control</font><font color="#800080">.</font><font color=Green>Monad</font><font color="#800080">.</font><font color=Green>Trans</font>

<font color=Blue>-- A computation in the continuation monad gets its continuation</font>
<font color=Blue>-- (what to do after it's done) as an argument.</font>

<u><font color="#804000">newtype</font></u> <font color=Green>Cont</font> r a <font color="#808080">=</font> <font color=Green>Cont</font> <font color="#808080">{</font> unCont <font color="#808080">::</font> <font color="#808080">(</font>a <font color="#808080">-&gt;</font> r<font color="#808080">)</font> <font color="#808080">-&gt;</font> r <font color="#808080">}</font>
                   <font color=Blue>--   continuation ^^^^^^</font>

<u><font color="#804000">instance</font></u> <font color=Green>Monad</font> <font color="#808080">(</font><font color=Green>Cont</font> r<font color="#808080">)</font> <u><font color="#804000">where</font></u>
  return x  <font color="#808080">=</font>  <font color=Green>Cont</font> <font color="#800080">$</font> <font color="#808080">\</font>k <font color="#808080">-&gt;</font> k x
  m <font color="#800080">&gt;&gt;=</font> f   <font color="#808080">=</font>  <font color=Green>Cont</font> <font color="#800080">$</font> <font color="#808080">\</font>k <font color="#808080">-&gt;</font> unCont m <font color="#800080">$</font> <font color="#808080">\</font>x <font color="#808080">-&gt;</font> unCont <font color="#808080">(</font>f x<font color="#808080">)</font> k

<font color=Blue>-- running is to continue by doing nothing (id)</font>
runCont <font color="#808080">::</font> <font color=Green>Cont</font> a a <font color="#808080">-&gt;</font> a
runCont m <font color="#808080">=</font> unCont m id

<u><font color="#804000">class</font></u> <font color=Green>Monad</font> m <font color="#808080">=&gt;</font> <font color=Green>MonadCont</font> m <u><font color="#804000">where</font></u>
  <font color=Blue>-- callCC gives a computation access to its continuation. This</font>
  <font color=Blue>-- continuation can be used to abort the computation (see</font>
  <font color=Blue>-- example below).</font>
  callCC <font color="#808080">::</font> <font color="#808080">(</font><font color="#808080">(</font>a <font color="#808080">-&gt;</font> m b<font color="#808080">)</font> <font color="#808080">-&gt;</font> m a<font color="#808080">)</font> <font color="#808080">-&gt;</font> m a

<u><font color="#804000">instance</font></u> <font color=Green>MonadCont</font> <font color="#808080">(</font><font color=Green>Cont</font> r<font color="#808080">)</font> <u><font color="#804000">where</font></u>
  <font color=Blue>-- callCC :: ((a -&gt; Cont r b) -&gt; Cont r a) -&gt; Cont r a</font>
  callCC f <font color="#808080">=</font> <font color=Green>Cont</font> <font color="#800080">$</font> <font color="#808080">\</font>k <font color="#808080">-&gt;</font> unCont <font color="#808080">(</font>f <font color="#808080">(</font>liftK k<font color="#808080">)</font><font color="#808080">)</font> k
    <u><font color="#804000">where</font></u>
      <font color=Blue>-- Lift the internal continuation to a computation.</font>
      liftK <font color="#808080">::</font> <font color="#808080">(</font>a <font color="#808080">-&gt;</font> r<font color="#808080">)</font> <font color="#808080">-&gt;</font> a <font color="#808080">-&gt;</font> <font color=Green>Cont</font> r b
      liftK k x <font color="#808080">=</font> <font color=Green>Cont</font> <font color="#800080">$</font> <font color="#808080">\</font><u><font color="#804000">_</font></u> <font color="#808080">-&gt;</font> k x

<font color=Blue>-- Example</font>
example <font color="#808080">::</font> <font color=Green>MonadCont</font> m <font color="#808080">=&gt;</font> <font color=Green>Int</font> <font color="#808080">-&gt;</font> m <font color=Green>Int</font>
example n <font color="#808080">=</font> <u><font color="#804000">do</font></u>
  x <font color="#808080">&lt;-</font> callCC <font color="#800080">$</font> <font color="#808080">\</font>k <font color="#808080">-&gt;</font> <u><font color="#804000">do</font></u>
         when <font color="#808080">(</font>even n<font color="#808080">)</font> <font color="#808080">(</font>k <font color=Magenta>0</font><font color="#808080">)</font> <font color=Blue>-- if n is even jump straight out of</font>
                             <font color=Blue>-- callCC with x = 0</font>
         return <font color="#808080">(</font>n <font color="#800080">+</font> <font color=Magenta>1</font><font color="#808080">)</font>
  return x

<font color=Blue>-- The transformer version</font>

<font color=Blue>-- Note that m doesn't have to be a monad for ContT r m to be a</font>
<font color=Blue>-- monad.</font>
<u><font color="#804000">newtype</font></u> <font color=Green>ContT</font> r m a <font color="#808080">=</font> <font color=Green>ContT</font> <font color="#808080">{</font> unContT <font color="#808080">::</font> <font color=Green>Cont</font> <font color="#808080">(</font>m r<font color="#808080">)</font> a <font color="#808080">}</font>
  <u><font color="#804000">deriving</font></u> <font color="#808080">(</font><font color=Green>Monad</font><font color="#808080">,</font> <font color=Green>MonadCont</font><font color="#808080">)</font>

runContT <font color="#808080">::</font> <font color=Green>Monad</font> m <font color="#808080">=&gt;</font> <font color=Green>ContT</font> a m a <font color="#808080">-&gt;</font> m a
runContT m <font color="#808080">=</font> unCont <font color="#808080">(</font>unContT m<font color="#808080">)</font> return

<u><font color="#804000">instance</font></u> <font color=Green>MonadTrans</font> <font color="#808080">(</font><font color=Green>ContT</font> r<font color="#808080">)</font> <u><font color="#804000">where</font></u>
  lift m <font color="#808080">=</font> <font color=Green>ContT</font> <font color="#800080">$</font> <font color=Green>Cont</font> <font color="#800080">$</font> <font color="#808080">\</font>k <font color="#808080">-&gt;</font> m <font color="#800080">&gt;&gt;=</font> k

<u><font color="#804000">instance</font></u> <font color=Green>MonadIO</font> m <font color="#808080">=&gt;</font> <font color=Green>MonadIO</font> <font color="#808080">(</font><font color=Green>ContT</font> r m<font color="#808080">)</font> <u><font color="#804000">where</font></u>
  liftIO <font color="#808080">=</font> lift <font color="#800080">.</font> liftIO
</pre>
</body>
</html>