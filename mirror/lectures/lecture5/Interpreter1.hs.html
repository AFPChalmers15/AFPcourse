<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>lectures/lecture5/Interpreter1.hs</title>
</head>
<body>
<pre><font color=Blue>{-# LANGUAGE GeneralizedNewtypeDeriving #-}</font>
<font color=Blue>-- | Version 1 of the interpreter</font>
<u><font color="#804000">module</font></u> <font color=Green>Interpreter1</font> <u><font color="#804000">where</font></u>

<u><font color="#804000">import</font></u> <u><font color="#804000">qualified</font></u> <font color=Green>Control</font><font color="#800080">.</font><font color=Green>Monad</font>          <u><font color="#804000">as</font></u> <font color=Green>CM</font>
<u><font color="#804000">import</font></u> <u><font color="#804000">qualified</font></u> <font color=Green>Control</font><font color="#800080">.</font><font color=Green>Monad</font><font color="#800080">.</font><font color=Green>Identity</font> <u><font color="#804000">as</font></u> <font color=Green>CMI</font>
<u><font color="#804000">import</font></u> <u><font color="#804000">qualified</font></u> <font color=Green>Control</font><font color="#800080">.</font><font color=Green>Monad</font><font color="#800080">.</font><font color=Green>Reader</font>   <u><font color="#804000">as</font></u> <font color=Green>CMR</font> <font color=Blue>-- new</font>

<u><font color="#804000">import</font></u> <font color=Green>Data</font><font color="#800080">.</font><font color=Green>Map</font> <font color="#808080">(</font><font color=Green>Map</font><font color="#808080">)</font>
<u><font color="#804000">import</font></u> <u><font color="#804000">qualified</font></u> <font color=Green>Data</font><font color="#800080">.</font><font color=Green>Map</font> <u><font color="#804000">as</font></u> <font color=Green>Map</font>

<u><font color="#804000">import</font></u> <u><font color="#804000">qualified</font></u> <font color=Green>Parser</font> <u><font color="#804000">as</font></u> <font color=Green>P</font> <font color="#808080">(</font>parseExpr<font color="#808080">,</font> <font color=Green>Language</font> <font color="#808080">(</font><font color="#808080">..</font><font color="#808080">)</font><font color="#808080">)</font>

<font color=Blue>-- | A more interesting language with variables and let bindings.</font>
<u><font color="#804000">data</font></u> <font color=Green>Expr</font> <font color="#808080">=</font> <font color=Green>Lit</font> <font color=Green>Integer</font>
          <font color="#808080">|</font> <font color=Green>Expr</font> <b><font color="#800080">:+</font></b> <font color=Green>Expr</font>
          <font color="#808080">|</font> <font color=Green>Var</font> <font color=Green>Name</font>            <font color=Blue>-- new</font>
          <font color="#808080">|</font> <font color=Green>Let</font> <font color=Green>Name</font> <font color=Green>Expr</font> <font color=Green>Expr</font>  <font color=Blue>-- new</font>
  <u><font color="#804000">deriving</font></u> <font color="#808080">(</font><font color=Green>Show</font><font color="#808080">)</font>

<u><font color="#804000">type</font></u> <font color=Green>Name</font>  <font color="#808080">=</font> <font color=Green>String</font>
<u><font color="#804000">type</font></u> <font color=Green>Value</font> <font color="#808080">=</font> <font color=Green>Integer</font>

<font color=Blue>-- | An environment maps variables to values.</font>
<u><font color="#804000">type</font></u> <font color=Green>Env</font> <font color="#808080">=</font> <font color=Green>Map</font> <font color=Green>Name</font> <font color=Green>Value</font>

emptyEnv <font color="#808080">::</font> <font color=Green>Env</font>
emptyEnv <font color="#808080">=</font> <font color=Green>Map</font><font color="#800080">.</font>empty

<font color=Blue>-- | The evaluation monad now keeps track of passing around</font>
<font color=Blue>-- the environment.</font>
<u><font color="#804000">newtype</font></u> <font color=Green>Eval</font> a <font color="#808080">=</font> <font color=Green>Eval</font> <font color="#808080">{</font> unEval <font color="#808080">::</font> <font color=Green>CMR</font><font color="#800080">.</font><font color=Green>ReaderT</font> <font color=Green>Env</font>
                                    <font color=Green>CMI</font><font color="#800080">.</font><font color=Green>Identity</font>
                                      a <font color="#808080">}</font>
  <u><font color="#804000">deriving</font></u> <font color="#808080">(</font><font color=Green>Monad</font><font color="#808080">,</font> <font color=Green>CMR</font><font color="#800080">.</font><font color=Green>MonadReader</font> <font color=Green>Env</font><font color="#808080">)</font>

runEval <font color="#808080">::</font> <font color=Green>Eval</font> a <font color="#808080">-&gt;</font> a
runEval <font color="#808080">=</font> <font color=Green>CMI</font><font color="#800080">.</font>runIdentity
        <font color="#800080">.</font> startReaderFrom emptyEnv
        <font color="#800080">.</font> unEval

startReaderFrom <font color="#808080">::</font> env <font color="#808080">-&gt;</font> <font color=Green>CMR</font><font color="#800080">.</font><font color=Green>ReaderT</font> env m a <font color="#808080">-&gt;</font> m a
startReaderFrom <font color="#808080">=</font> flip <font color=Green>CMR</font><font color="#800080">.</font>runReaderT
  <font color=Blue>-- &gt; CMR.runReaderT :: CMR.ReaderT env m a -&gt;</font>
  <font color=Blue>-- &gt;                              (env -&gt; m a)</font>

<font color=Blue>-- * Environment manipulation</font>

<font color=Blue>-- | Looking up the value of a variable in the enviroment.</font>
lookupVar <font color="#808080">::</font> <font color=Green>Name</font> <font color="#808080">-&gt;</font> <font color=Green>Eval</font> <font color=Green>Value</font>
lookupVar x <font color="#808080">=</font> <u><font color="#804000">do</font></u>
  env <font color="#808080">&lt;-</font> <font color=Green>CMR</font><font color="#800080">.</font>ask
  <u><font color="#804000">case</font></u> <font color=Green>Map</font><font color="#800080">.</font>lookup x env <u><font color="#804000">of</font></u>
    <font color=Green>Nothing</font> <font color="#808080">-&gt;</font> fail <font color="#808080">(</font><font color=Magenta>"lookupVar: unbound variable: "</font> <font color="#800080">++</font> x<font color="#808080">)</font>
    <font color=Green>Just</font> v  <font color="#808080">-&gt;</font> return v
<font color=Blue>-- Here CMR.ask :: Eval Env</font>

<font color=Blue>-- | We can extend the environment with a new binding for a local</font>
<font color=Blue>-- computation.  Since we're using a reader monad we can be sure</font>
<font color=Blue>-- that this binding does not escape outside its intended scope.</font>
extendEnv <font color="#808080">::</font> <font color=Green>Name</font> <font color="#808080">-&gt;</font> <font color=Green>Value</font> <font color="#808080">-&gt;</font> <font color=Green>Eval</font> a <font color="#808080">-&gt;</font> <font color=Green>Eval</font> a
extendEnv x v <font color="#808080">=</font> <font color=Green>CMR</font><font color="#800080">.</font>local <font color="#808080">(</font><font color=Green>Map</font><font color="#800080">.</font>insert x v<font color="#808080">)</font>
<font color=Blue>-- In general:</font>
<font color=Blue>-- &gt; CMR.local :: (CMR.MonadReader r m) =&gt; (r -&gt; r) -&gt; m a -&gt; m a</font>


<font color=Blue>-- | The evaluator is extended by simply adding cases for the</font>
<font color=Blue>-- two new constructs. None of the old stuff has to change.</font>
eval <font color="#808080">::</font> <font color=Green>Expr</font> <font color="#808080">-&gt;</font> <font color=Green>Eval</font> <font color=Green>Value</font>
eval <font color="#808080">(</font><font color=Green>Lit</font> n<font color="#808080">)</font>        <font color="#808080">=</font> return n
eval <font color="#808080">(</font>a <b><font color="#800080">:+</font></b> b<font color="#808080">)</font>       <font color="#808080">=</font> <font color=Green>CM</font><font color="#800080">.</font>liftM2 <font color="#808080">(</font><font color="#800080">+</font><font color="#808080">)</font> <font color="#808080">(</font>eval a<font color="#808080">)</font> <font color="#808080">(</font>eval b<font color="#808080">)</font>
eval <font color="#808080">(</font><font color=Green>Var</font> x<font color="#808080">)</font>        <font color="#808080">=</font> lookupVar x
eval <font color="#808080">(</font><font color=Green>Let</font> x e1 e2<font color="#808080">)</font>  <font color="#808080">=</font> <u><font color="#804000">do</font></u>
  v1 <font color="#808080">&lt;-</font> eval e1
  extendEnv x v1 <font color="#808080">(</font>eval e2<font color="#808080">)</font>

<font color=Blue>-- * Utilities: testing and parsing</font>

testExpr <font color="#808080">=</font> parse <font color=Magenta>"let x=1+2; x+x"</font>
test <font color="#808080">=</font> runEval <font color="#800080">$</font> eval testExpr

<font color=Blue>-- | The parser is parameterised over the abstract syntax.</font>
language <font color="#808080">=</font> <font color=Green>P</font><font color="#800080">.</font><font color=Green>Lang</font>
  <font color="#808080">{</font> <font color=Green>P</font><font color="#800080">.</font>lLit    <font color="#808080">=</font> <font color=Green>Lit</font>
  <font color="#808080">,</font> <font color=Green>P</font><font color="#800080">.</font>lPlus   <font color="#808080">=</font> <font color="#808080">(</font><b><font color="#800080">:+</font></b><font color="#808080">)</font>
  <font color="#808080">,</font> <font color=Green>P</font><font color="#800080">.</font>lLet    <font color="#808080">=</font> <font color=Green>Let</font>
  <font color="#808080">,</font> <font color=Green>P</font><font color="#800080">.</font>lVar    <font color="#808080">=</font> <font color=Green>Var</font>
  <font color="#808080">,</font> <font color=Green>P</font><font color="#800080">.</font>lNewref <font color="#808080">=</font> error <font color=Magenta>"language: not implemented: new"</font>
  <font color="#808080">,</font> <font color=Green>P</font><font color="#800080">.</font>lDeref  <font color="#808080">=</font> error <font color=Magenta>"language: not implemented: !"</font>
  <font color="#808080">,</font> <font color=Green>P</font><font color="#800080">.</font>lAssign <font color="#808080">=</font> error <font color=Magenta>"language: not implemented: :="</font>
  <font color="#808080">,</font> <font color=Green>P</font><font color="#800080">.</font>lCatch  <font color="#808080">=</font> error <font color=Magenta>"language: not implemented: catch"</font>
  <font color="#808080">}</font>

parse s <font color="#808080">=</font> <u><font color="#804000">case</font></u>  <font color=Green>P</font><font color="#800080">.</font>parseExpr language s  <u><font color="#804000">of</font></u>
  <font color=Green>Left</font> err  <font color="#808080">-&gt;</font> error <font color="#808080">(</font>show err<font color="#808080">)</font>
  <font color=Green>Right</font> x   <font color="#808080">-&gt;</font> x
</pre>
</body>
</html>