<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>lectures/lecture5/Parser.hs</title>
</head>
<body>
<pre>
<u><font color="#804000">module</font></u> <font color=Green>Parser</font> <u><font color="#804000">where</font></u>

<u><font color="#804000">import</font></u> <font color=Green>Control</font><font color="#800080">.</font><font color=Green>Applicative</font> hiding <font color="#808080">(</font><font color="#808080">(</font><font color="#800080">&lt;|&gt;</font><font color="#808080">)</font><font color="#808080">)</font>
<u><font color="#804000">import</font></u> <font color=Green>Data</font><font color="#800080">.</font><font color=Green>Char</font>
<u><font color="#804000">import</font></u> <font color=Green>Text</font><font color="#800080">.</font><font color=Green>ParserCombinators</font><font color="#800080">.</font><font color=Green>Parsec</font><font color="#800080">.</font><font color=Green>Token</font>
<u><font color="#804000">import</font></u> <font color=Green>Text</font><font color="#800080">.</font><font color=Green>ParserCombinators</font><font color="#800080">.</font><font color=Green>Parsec</font>

<u><font color="#804000">data</font></u> <font color=Green>Language</font> e <font color="#808080">=</font>
  <font color=Green>Lang</font> <font color="#808080">{</font> lLit    <font color="#808080">::</font> <font color=Green>Integer</font> <font color="#808080">-&gt;</font> e
       <font color="#808080">,</font> lPlus   <font color="#808080">::</font> e <font color="#808080">-&gt;</font> e <font color="#808080">-&gt;</font> e
       <font color="#808080">,</font> lLet    <font color="#808080">::</font> <font color=Green>String</font> <font color="#808080">-&gt;</font> e <font color="#808080">-&gt;</font> e <font color="#808080">-&gt;</font> e
       <font color="#808080">,</font> lVar    <font color="#808080">::</font> <font color=Green>String</font> <font color="#808080">-&gt;</font> e
       <font color="#808080">,</font> lNewref <font color="#808080">::</font> e <font color="#808080">-&gt;</font> e
       <font color="#808080">,</font> lDeref  <font color="#808080">::</font> e <font color="#808080">-&gt;</font> e
       <font color="#808080">,</font> lAssign <font color="#808080">::</font> e <font color="#808080">-&gt;</font> e <font color="#808080">-&gt;</font> e
       <font color="#808080">,</font> lCatch  <font color="#808080">::</font> e <font color="#808080">-&gt;</font> e <font color="#808080">-&gt;</font> e
       <font color="#808080">}</font>

tok <font color="#808080">::</font> <font color=Green>TokenParser</font> st
tok <font color="#808080">=</font> makeTokenParser <font color=Green>LanguageDef</font>
  <font color="#808080">{</font> commentStart    <font color="#808080">=</font> <font color=Magenta>"{-"</font>
  <font color="#808080">,</font> commentEnd      <font color="#808080">=</font> <font color=Magenta>"-}"</font>
  <font color="#808080">,</font> commentLine     <font color="#808080">=</font> <font color=Magenta>"--"</font>
  <font color="#808080">,</font> nestedComments  <font color="#808080">=</font> <font color=Green>True</font>
  <font color="#808080">,</font> identStart      <font color="#808080">=</font> satisfy <font color="#808080">(</font><font color="#808080">\</font>c <font color="#808080">-&gt;</font> isAlpha c <font color="#800080">||</font> c <font color="#800080">==</font> <font color=Magenta>'_'</font><font color="#808080">)</font>
  <font color="#808080">,</font> identLetter     <font color="#808080">=</font> satisfy <font color="#808080">(</font><font color="#808080">\</font>c <font color="#808080">-&gt;</font> isAlphaNum c <font color="#800080">||</font> c <font color="#800080">==</font> <font color=Magenta>'_'</font><font color="#808080">)</font>
  <font color="#808080">,</font> opStart         <font color="#808080">=</font> satisfy <font color="#808080">(</font><font color="#800080">`elem`</font> <font color=Magenta>"+:=!;"</font><font color="#808080">)</font>
  <font color="#808080">,</font> opLetter        <font color="#808080">=</font> satisfy <font color="#808080">(</font><font color="#800080">`elem`</font> <font color=Magenta>"="</font><font color="#808080">)</font>
  <font color="#808080">,</font> reservedNames   <font color="#808080">=</font> <font color="#808080">[</font><font color=Magenta>"let"</font><font color="#808080">,</font> <font color=Magenta>"new"</font><font color="#808080">,</font> <font color=Magenta>"try"</font><font color="#808080">,</font> <font color=Magenta>"catch"</font><font color="#808080">]</font>
  <font color="#808080">,</font> reservedOpNames <font color="#808080">=</font> <font color="#808080">[</font><font color=Magenta>"+"</font><font color="#808080">,</font> <font color=Magenta>":="</font><font color="#808080">,</font> <font color=Magenta>"="</font><font color="#808080">,</font> <font color=Magenta>"!"</font><font color="#808080">,</font> <font color=Magenta>";"</font><font color="#808080">]</font>
  <font color="#808080">,</font> caseSensitive   <font color="#808080">=</font> <font color=Green>True</font>
  <font color="#808080">}</font>

parseExpr <font color="#808080">::</font> <font color=Green>Language</font> e <font color="#808080">-&gt;</font> <font color=Green>String</font> <font color="#808080">-&gt;</font> <font color=Green>Either</font> <font color=Green>ParseError</font> e
parseExpr lang <font color="#808080">=</font> parse exprP <font color=Magenta>""</font>
  <u><font color="#804000">where</font></u>

    exprP <font color="#808080">=</font> <u><font color="#804000">do</font></u>
      e <font color="#808080">&lt;-</font> expr0
      eof
      return e

    expr0 <font color="#808080">=</font> choice
      <font color="#808080">[</font> <u><font color="#804000">do</font></u> reserved tok <font color=Magenta>"let"</font>
           x <font color="#808080">&lt;-</font> identifier tok
           reservedOp tok <font color=Magenta>"="</font>
           e1 <font color="#808080">&lt;-</font> expr2
           reservedOp tok <font color=Magenta>";"</font>
           e2 <font color="#808080">&lt;-</font> expr0
           return <font color="#800080">$</font> lLet lang x e1 e2
      <font color="#808080">,</font> <u><font color="#804000">do</font></u> reserved tok <font color=Magenta>"try"</font>
           e1 <font color="#808080">&lt;-</font> expr0
           reserved tok <font color=Magenta>"catch"</font>
           e2 <font color="#808080">&lt;-</font> expr0
           return <font color="#800080">$</font> lCatch lang e1 e2
      <font color="#808080">,</font> expr1
      <font color="#808080">]</font>

    expr1 <font color="#808080">=</font> chainr1 expr2 <font color="#808080">(</font>reservedOp tok <font color=Magenta>";"</font> <font color="#800080">&gt;&gt;</font> return <font color="#808080">(</font>lLet lang <font color=Magenta>"_"</font><font color="#808080">)</font><font color="#808080">)</font>
    expr2 <font color="#808080">=</font> chainr1 expr3 <font color="#808080">(</font>reservedOp tok <font color=Magenta>":="</font> <font color="#800080">&gt;&gt;</font> return <font color="#808080">(</font>lAssign lang<font color="#808080">)</font><font color="#808080">)</font>
    expr3 <font color="#808080">=</font> chainl1 expr4 plusP
    expr4 <font color="#808080">=</font> choice
      <font color="#808080">[</font> atomP
      <font color="#808080">,</font> <u><font color="#804000">do</font></u> reservedOp tok <font color=Magenta>"!"</font>
           e <font color="#808080">&lt;-</font> expr4
           return <font color="#808080">(</font>lDeref lang e<font color="#808080">)</font>
      <font color="#808080">,</font> <u><font color="#804000">do</font></u> reserved tok <font color=Magenta>"new"</font>
           e <font color="#808080">&lt;-</font> expr4
           return <font color="#808080">(</font>lNewref lang e<font color="#808080">)</font>
      <font color="#808080">]</font>

    atomP <font color="#808080">=</font> choice
      <font color="#808080">[</font> lLit lang <font color="#800080">&lt;$&gt;</font> integer tok
      <font color="#808080">,</font> lVar lang <font color="#800080">&lt;$&gt;</font> identifier tok
      <font color="#808080">,</font> parens tok expr0
      <font color="#808080">]</font>

    plusP <font color="#808080">=</font> reservedOp tok <font color=Magenta>"+"</font> <font color="#800080">&gt;&gt;</font> return <font color="#808080">(</font>lPlus lang<font color="#808080">)</font>

</pre>
</body>
</html>