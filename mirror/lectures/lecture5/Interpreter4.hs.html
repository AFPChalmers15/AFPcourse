<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>lectures/lecture5/Interpreter4.hs</title>
</head>
<body>
<pre><font color=Blue>{-# LANGUAGE GeneralizedNewtypeDeriving #-}</font>
<font color=Blue>-- | Version 4 of the interpreter</font>
<u><font color="#804000">module</font></u> <font color=Green>Interpreter4</font> <u><font color="#804000">where</font></u>

<u><font color="#804000">import</font></u> <u><font color="#804000">qualified</font></u> <font color=Green>Control</font><font color="#800080">.</font><font color=Green>Monad</font>          <u><font color="#804000">as</font></u> <font color=Green>CM</font>
<u><font color="#804000">import</font></u> <u><font color="#804000">qualified</font></u> <font color=Green>Control</font><font color="#800080">.</font><font color=Green>Monad</font><font color="#800080">.</font><font color=Green>Identity</font> <u><font color="#804000">as</font></u> <font color=Green>CMI</font>
<u><font color="#804000">import</font></u> <u><font color="#804000">qualified</font></u> <font color=Green>Control</font><font color="#800080">.</font><font color=Green>Monad</font><font color="#800080">.</font><font color=Green>Reader</font>   <u><font color="#804000">as</font></u> <font color=Green>CMR</font>
<u><font color="#804000">import</font></u> <u><font color="#804000">qualified</font></u> <font color=Green>Control</font><font color="#800080">.</font><font color=Green>Monad</font><font color="#800080">.</font><font color=Green>State</font>    <u><font color="#804000">as</font></u> <font color=Green>CMS</font>
<u><font color="#804000">import</font></u> <u><font color="#804000">qualified</font></u> <font color=Green>Control</font><font color="#800080">.</font><font color=Green>Monad</font><font color="#800080">.</font><font color=Green>Error</font>    <u><font color="#804000">as</font></u> <font color=Green>CME</font>

<u><font color="#804000">import</font></u> <font color=Green>Data</font><font color="#800080">.</font><font color=Green>Map</font> <font color="#808080">(</font><font color=Green>Map</font><font color="#808080">)</font>
<u><font color="#804000">import</font></u> <u><font color="#804000">qualified</font></u> <font color=Green>Data</font><font color="#800080">.</font><font color=Green>Map</font> <u><font color="#804000">as</font></u> <font color=Green>Map</font>

<u><font color="#804000">import</font></u> <u><font color="#804000">qualified</font></u> <font color=Green>Parser</font> <u><font color="#804000">as</font></u> <font color=Green>P</font><font color="#808080">(</font>parseExpr<font color="#808080">,</font> <font color=Green>Language</font><font color="#808080">(</font><font color="#808080">..</font><font color="#808080">)</font><font color="#808080">)</font>

<font color=Blue>-- Same datatype - this version is only varying the monad transformers</font>
<u><font color="#804000">data</font></u> <font color=Green>Expr</font> <font color="#808080">=</font> <font color=Green>Lit</font> <font color=Green>Integer</font>
          <font color="#808080">|</font> <font color=Green>Expr</font> <b><font color="#800080">:+</font></b> <font color=Green>Expr</font>
          <font color="#808080">|</font> <font color=Green>Var</font> <font color=Green>Name</font>
          <font color="#808080">|</font> <font color=Green>Let</font> <font color=Green>Name</font> <font color=Green>Expr</font> <font color=Green>Expr</font>
          <font color="#808080">|</font> <font color=Green>NewRef</font> <font color=Green>Expr</font>
          <font color="#808080">|</font> <font color=Green>Deref</font> <font color=Green>Expr</font>
          <font color="#808080">|</font> <font color=Green>Expr</font> <b><font color="#800080">:=</font></b> <font color=Green>Expr</font>
          <font color="#808080">|</font> <font color=Green>Catch</font> <font color=Green>Expr</font> <font color=Green>Expr</font>
  <u><font color="#804000">deriving</font></u> <font color="#808080">(</font><font color=Green>Show</font><font color="#808080">)</font>

<u><font color="#804000">type</font></u> <font color=Green>Name</font>  <font color="#808080">=</font> <font color=Green>String</font>
<u><font color="#804000">type</font></u> <font color=Green>Value</font> <font color="#808080">=</font> <font color=Green>Integer</font>
<u><font color="#804000">type</font></u> <font color=Green>Ptr</font>   <font color="#808080">=</font> <font color=Green>Value</font>
  <font color=Blue>-- dangerous language: any value can be used as a pointer</font>

<font color=Blue>-- | An environment maps variables to values.</font>
<u><font color="#804000">type</font></u> <font color=Green>Env</font> <font color="#808080">=</font> <font color=Green>Map</font> <font color=Green>Name</font> <font color=Green>Value</font>

emptyEnv <font color="#808080">::</font> <font color=Green>Env</font>
emptyEnv <font color="#808080">=</font> <font color=Green>Map</font><font color="#800080">.</font>empty

<font color=Blue>-- | We need to keep track of the store containing the values of our</font>
<font color=Blue>--   references. We also remember the next unused pointer.</font>
<u><font color="#804000">data</font></u> <font color=Green>Store</font> <font color="#808080">=</font> <font color=Green>Store</font> <font color="#808080">{</font> nextPtr <font color="#808080">::</font> <font color=Green>Ptr</font>
                   <font color="#808080">,</font> heap    <font color="#808080">::</font> <font color=Green>Map</font> <font color=Green>Ptr</font> <font color=Green>Value</font>
                   <font color="#808080">}</font>

emptyStore <font color="#808080">::</font> <font color=Green>Store</font>
emptyStore <font color="#808080">=</font> <font color=Green>Store</font> <font color=Magenta>0</font> <font color=Green>Map</font><font color="#800080">.</font>empty

<font color=Blue>-- | We add an exception type...</font>
<u><font color="#804000">data</font></u> <font color=Green>Err</font> <font color="#808080">=</font> <font color=Green>SegmentationFault</font>
         <font color="#808080">|</font> <font color=Green>UnboundVariable</font> <font color=Green>String</font>
         <font color="#808080">|</font> <font color=Green>OtherError</font> <font color=Green>String</font>
  <u><font color="#804000">deriving</font></u> <font color=Green>Show</font>

<font color=Blue>-- | ...and explain how to turn strings into exceptions. This is used</font>
<font color=Blue>--   for the fail operation in the monad.</font>
<u><font color="#804000">instance</font></u> <font color=Green>CME</font><font color="#800080">.</font><font color=Green>Error</font> <font color=Green>Err</font> <u><font color="#804000">where</font></u>
  strMsg <font color="#808080">=</font> <font color=Green>OtherError</font>
  noMsg  <font color="#808080">=</font> <font color=Green>CME</font><font color="#800080">.</font>strMsg <font color=Magenta>""</font>

<font color=Blue>{-| We add an error monad to our evaluation monad. It matters whether
    we stick the error monad on the outside or the inside of the state
    monad. In this case we stick it on the inside.

    We can understand the interaction between the state monad and the
    error monad by looking at their implementations. With ErrorT on
    the outside, we will represent computations as

      ms (Either err a)   ~=   s -&gt; (Either err a,  s)

    where ms is the underlying monad with state. Since the state is
    hidden inside m it is not affected by whether we return @Right a@
    or @Left err@.  In other words state changes won't be rolled back
    when there's an exception.

    If we turn it around, adding a state monad on top of an error
    monad, computations will be represented as

      s -&gt; me (a, s)      ~=   s -&gt; Either err  (a, s)

    Here it's clear that if a computation fails, we lose any changes
    to the state made by the failing computation since the state is
    just passed as a return value in the underlying monad.
-}</font>

<u><font color="#804000">newtype</font></u> <font color=Green>Eval1</font> a <font color="#808080">=</font> <font color=Green>Eval1</font><font color="#808080">{</font> unEval1<font color="#808080">::</font> <font color=Green>CMS</font><font color="#800080">.</font><font color=Green>StateT</font> <font color=Green>Store</font>
                                     <font color="#808080">(</font><font color=Green>CMR</font><font color="#800080">.</font><font color=Green>ReaderT</font> <font color=Green>Env</font>
                                       <font color="#808080">(</font><font color=Green>CME</font><font color="#800080">.</font><font color=Green>ErrorT</font> <font color=Green>Err</font>
                                         <font color=Green>CMI</font><font color="#800080">.</font><font color=Green>Identity</font><font color="#808080">)</font><font color="#808080">)</font>
                                           a <font color="#808080">}</font>
  <u><font color="#804000">deriving</font></u> <font color="#808080">(</font><font color=Green>Monad</font><font color="#808080">,</font> <font color=Green>CMS</font><font color="#800080">.</font><font color=Green>MonadState</font>  <font color=Green>Store</font><font color="#808080">,</font>
                   <font color=Green>CMR</font><font color="#800080">.</font><font color=Green>MonadReader</font> <font color=Green>Env</font><font color="#808080">,</font>
                   <font color=Green>CME</font><font color="#800080">.</font><font color=Green>MonadError</font>  <font color=Green>Err</font><font color="#808080">)</font>

<u><font color="#804000">newtype</font></u> <font color=Green>Eval2</font> a <font color="#808080">=</font> <font color=Green>Eval2</font><font color="#808080">{</font> unEval2<font color="#808080">::</font> <font color=Green>CME</font><font color="#800080">.</font><font color=Green>ErrorT</font> <font color=Green>Err</font>
                                     <font color="#808080">(</font><font color=Green>CMS</font><font color="#800080">.</font><font color=Green>StateT</font> <font color=Green>Store</font>
                                       <font color="#808080">(</font><font color=Green>CMR</font><font color="#800080">.</font><font color=Green>ReaderT</font> <font color=Green>Env</font>
                                         <font color=Green>CMI</font><font color="#800080">.</font><font color=Green>Identity</font><font color="#808080">)</font><font color="#808080">)</font>
                                           a <font color="#808080">}</font>
  <u><font color="#804000">deriving</font></u> <font color="#808080">(</font><font color=Green>Monad</font><font color="#808080">,</font> <font color=Green>CMS</font><font color="#800080">.</font><font color=Green>MonadState</font>  <font color=Green>Store</font><font color="#808080">,</font>
                   <font color=Green>CMR</font><font color="#800080">.</font><font color=Green>MonadReader</font> <font color=Green>Env</font><font color="#808080">,</font>
                   <font color=Green>CME</font><font color="#800080">.</font><font color=Green>MonadError</font>  <font color=Green>Err</font><font color="#808080">)</font>

runEval1 <font color="#808080">::</font> <font color=Green>Eval1</font> a <font color="#808080">-&gt;</font> <font color=Green>Either</font> <font color=Green>Err</font> a
runEval1 <font color="#808080">=</font> <font color=Green>CMI</font><font color="#800080">.</font>runIdentity
         <font color="#800080">.</font> <font color=Green>CME</font><font color="#800080">.</font>runErrorT
         <font color="#800080">.</font> startReaderFrom emptyEnv
         <font color="#800080">.</font> startStateFrom  emptyStore
         <font color="#800080">.</font> unEval1

runEval2 <font color="#808080">::</font> <font color=Green>Eval2</font> a <font color="#808080">-&gt;</font> <font color=Green>Either</font> <font color=Green>Err</font> a
runEval2 <font color="#808080">=</font> <font color=Green>CMI</font><font color="#800080">.</font>runIdentity
         <font color="#800080">.</font> startReaderFrom emptyEnv
         <font color="#800080">.</font> startStateFrom  emptyStore
         <font color="#800080">.</font> <font color=Green>CME</font><font color="#800080">.</font>runErrorT
         <font color="#800080">.</font> unEval2

startStateFrom <font color="#808080">::</font> <font color=Green>Monad</font> m <font color="#808080">=&gt;</font> state <font color="#808080">-&gt;</font> <font color=Green>CMS</font><font color="#800080">.</font><font color=Green>StateT</font> state m a <font color="#808080">-&gt;</font> m a
startStateFrom <font color="#808080">=</font> flip <font color=Green>CMS</font><font color="#800080">.</font>evalStateT
  <font color=Blue>-- CMS.evalStateT :: Monad m =&gt; CMS.StateT state m a -&gt;</font>
  <font color=Blue>--                                (state -&gt; m a)</font>

startReaderFrom <font color="#808080">::</font> env <font color="#808080">-&gt;</font> <font color=Green>CMR</font><font color="#800080">.</font><font color=Green>ReaderT</font> env m a <font color="#808080">-&gt;</font> m a
startReaderFrom <font color="#808080">=</font> flip <font color=Green>CMR</font><font color="#800080">.</font>runReaderT
  <font color=Blue>-- CMR.runReaderT :: CMR.ReaderT env m a -&gt;</font>
  <font color=Blue>--                              (env -&gt; m a)</font>


<font color=Blue>-- * Environment stuff</font>

<font color=Blue>-- | Here we just remove the type annotation</font>
<font color=Blue>-- lookupVar :: Name -&gt; Eval Value</font>
lookupVar x <font color="#808080">=</font> <u><font color="#804000">do</font></u>
  env <font color="#808080">&lt;-</font> <font color=Green>CMR</font><font color="#800080">.</font>ask
  <u><font color="#804000">case</font></u> <font color=Green>Map</font><font color="#800080">.</font>lookup x env <u><font color="#804000">of</font></u>
    <font color=Green>Nothing</font> <font color="#808080">-&gt;</font> <font color=Green>CME</font><font color="#800080">.</font>throwError <font color="#800080">$</font> <font color=Green>UnboundVariable</font> x
    <font color=Green>Just</font> v  <font color="#808080">-&gt;</font> return v

<font color=Blue>-- extendEnv :: Name -&gt; Value -&gt; Eval a -&gt; Eval a</font>
extendEnv x v <font color="#808080">=</font> <font color=Green>CMR</font><font color="#800080">.</font>local <font color="#808080">(</font><font color=Green>Map</font><font color="#800080">.</font>insert x v<font color="#808080">)</font>

<font color=Blue>-- * Store stuff</font>

<font color=Blue>-- | Create a new reference containing the given value.</font>
<font color=Blue>-- newRef :: Value -&gt; Eval Ptr</font>
newRef v <font color="#808080">=</font> <u><font color="#804000">do</font></u>
  s <font color="#808080">&lt;-</font> <font color=Green>CMS</font><font color="#800080">.</font>get
  <u><font color="#804000">let</font></u> ptr <font color="#808080">=</font> nextPtr s
      s'  <font color="#808080">=</font> s <font color="#808080">{</font> nextPtr <font color="#808080">=</font> ptr <font color="#800080">+</font> <font color=Magenta>1</font>
              <font color="#808080">,</font> heap    <font color="#808080">=</font> <font color=Green>Map</font><font color="#800080">.</font>insert ptr v <font color="#808080">(</font>heap s<font color="#808080">)</font>
              <font color="#808080">}</font>
  <font color=Green>CMS</font><font color="#800080">.</font>put s'
  return ptr

<font color=Blue>-- | This has also been changed to throw an error.</font>
<font color=Blue>-- deref :: Ptr -&gt; Eval Value</font>
deref p <font color="#808080">=</font> <u><font color="#804000">do</font></u>
  h <font color="#808080">&lt;-</font> <font color=Green>CMS</font><font color="#800080">.</font>gets heap
  <u><font color="#804000">case</font></u> <font color=Green>Map</font><font color="#800080">.</font>lookup p h <u><font color="#804000">of</font></u>
    <font color=Green>Nothing</font> <font color="#808080">-&gt;</font> <font color=Green>CME</font><font color="#800080">.</font>throwError <font color=Green>SegmentationFault</font>
    <font color=Green>Just</font> v  <font color="#808080">-&gt;</font> return v

<font color=Blue>-- (=:) :: Ptr -&gt; Value -&gt; Eval Value</font>
p <font color="#800080">=:</font> v <font color="#808080">=</font> <u><font color="#804000">do</font></u>
  <font color=Green>CMS</font><font color="#800080">.</font>modify <font color="#800080">$</font> <font color="#808080">\</font>s <font color="#808080">-&gt;</font> s <font color="#808080">{</font> heap <font color="#808080">=</font> <font color=Green>Map</font><font color="#800080">.</font>adjust <font color="#808080">(</font>const v<font color="#808080">)</font> p <font color="#808080">(</font>heap s<font color="#808080">)</font> <font color="#808080">}</font>
  return v

<font color=Blue>-- | The case for 'Catch' simply uses the 'catchError' function from</font>
<font color=Blue>--   the error monad.</font>
<font color=Blue>-- eval :: Expr -&gt; Eval Value</font>
eval <font color="#808080">(</font><font color=Green>Lit</font> n<font color="#808080">)</font>       <font color="#808080">=</font> return n
eval <font color="#808080">(</font>a <b><font color="#800080">:+</font></b> b<font color="#808080">)</font>      <font color="#808080">=</font> <font color=Green>CM</font><font color="#800080">.</font>liftM2 <font color="#808080">(</font><font color="#800080">+</font><font color="#808080">)</font> <font color="#808080">(</font>eval a<font color="#808080">)</font> <font color="#808080">(</font>eval b<font color="#808080">)</font>
eval <font color="#808080">(</font><font color=Green>Var</font> x<font color="#808080">)</font>       <font color="#808080">=</font> lookupVar x
eval <font color="#808080">(</font><font color=Green>Let</font> x e1 e2<font color="#808080">)</font> <font color="#808080">=</font> <u><font color="#804000">do</font></u>
  v1 <font color="#808080">&lt;-</font> eval e1
  extendEnv x v1 <font color="#808080">(</font>eval e2<font color="#808080">)</font>
eval <font color="#808080">(</font><font color=Green>NewRef</font> e<font color="#808080">)</font>    <font color="#808080">=</font> newRef <font color="#800080">=&lt;&lt;</font> eval e
eval <font color="#808080">(</font><font color=Green>Deref</font> e<font color="#808080">)</font>     <font color="#808080">=</font> deref <font color="#800080">=&lt;&lt;</font> eval e
eval <font color="#808080">(</font>pe <b><font color="#800080">:=</font></b> ve<font color="#808080">)</font>    <font color="#808080">=</font> <u><font color="#804000">do</font></u>
  p <font color="#808080">&lt;-</font> eval pe
  v <font color="#808080">&lt;-</font> eval ve
  p <font color="#800080">=:</font> v
eval <font color="#808080">(</font><font color=Green>Catch</font> e1 e2<font color="#808080">)</font> <font color="#808080">=</font> eval e1 <font color="#800080">`</font><font color=Green>CME</font><font color="#800080">.</font>catchError<font color="#800080">`</font> <font color="#808080">\</font><u><font color="#804000">_</font></u> <font color="#808080">-&gt;</font> eval e2

<font color=Blue>-- | Examples</font>

testExpr1 <font color="#808080">=</font> parse <font color=Magenta>"!p+1738"</font>
testExpr2 <font color="#808080">=</font> parse <font color=Magenta>"(try !p catch 0)+1738"</font>
test1 <font color="#808080">=</font> runEval1 <font color="#800080">$</font> eval testExpr1
test2 <font color="#808080">=</font> runEval2 <font color="#800080">$</font> eval testExpr2
testExpr3 <font color="#808080">=</font> parse <font color=Magenta>"let one = new 1; \
                 \ let dummy = (try ((one := 2) + !7) catch 0); \
                 \ !one"</font>
<font color=Blue>-- value is 1 if state is discarded when error occurs</font>
<font color=Blue>-- value is 2 if state is preserved up to the error</font>
test31 <font color="#808080">=</font> runEval1 <font color="#800080">$</font> eval testExpr3
test32 <font color="#808080">=</font> runEval2 <font color="#800080">$</font> eval testExpr3

<font color=Blue>-- Exercise: use QuickCheck to find a minimal example for which</font>
<font color=Blue>--   runEval1 and runEval2 are different.</font>

<font color=Blue>----------------</font>
<font color=Blue>-- | Parser stuff.</font>
language <font color="#808080">=</font> <font color=Green>P</font><font color="#800080">.</font><font color=Green>Lang</font>
  <font color="#808080">{</font> <font color=Green>P</font><font color="#800080">.</font>lLit    <font color="#808080">=</font> <font color=Green>Lit</font>
  <font color="#808080">,</font> <font color=Green>P</font><font color="#800080">.</font>lPlus   <font color="#808080">=</font> <font color="#808080">(</font><b><font color="#800080">:+</font></b><font color="#808080">)</font>
  <font color="#808080">,</font> <font color=Green>P</font><font color="#800080">.</font>lLet    <font color="#808080">=</font> <font color=Green>Let</font>
  <font color="#808080">,</font> <font color=Green>P</font><font color="#800080">.</font>lVar    <font color="#808080">=</font> <font color=Green>Var</font>
  <font color="#808080">,</font> <font color=Green>P</font><font color="#800080">.</font>lNewref <font color="#808080">=</font> <font color=Green>NewRef</font>
  <font color="#808080">,</font> <font color=Green>P</font><font color="#800080">.</font>lDeref  <font color="#808080">=</font> <font color=Green>Deref</font>
  <font color="#808080">,</font> <font color=Green>P</font><font color="#800080">.</font>lAssign <font color="#808080">=</font> <font color="#808080">(</font><b><font color="#800080">:=</font></b><font color="#808080">)</font>
  <font color="#808080">,</font> <font color=Green>P</font><font color="#800080">.</font>lCatch  <font color="#808080">=</font> <font color=Green>Catch</font>
  <font color="#808080">}</font>

parse s <font color="#808080">=</font> <u><font color="#804000">case</font></u> <font color=Green>P</font><font color="#800080">.</font>parseExpr language s <u><font color="#804000">of</font></u>
  <font color=Green>Left</font> err <font color="#808080">-&gt;</font> error <font color="#808080">(</font>show err<font color="#808080">)</font>
  <font color=Green>Right</font> x  <font color="#808080">-&gt;</font> x
</pre>
</body>
</html>